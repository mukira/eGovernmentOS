// POLYFILL FOR BROWSEROS API
(function () {
    if (typeof chrome === 'undefined') return;

    // Ensure chrome.browserOS exists
    if (!chrome.browserOS) {
        chrome.browserOS = {};
    }

    console.log("[Polyfill] Initializing BrowserOS Polyfill...");

    // Mock getVersionNumber
    chrome.browserOS.getVersionNumber = function (callback) {
        console.log("[Polyfill] getVersionNumber called");
        if (callback) callback("0.0.0.35");
    };

    // Mock getBrowserosVersionNumber
    chrome.browserOS.getBrowserosVersionNumber = function (callback) {
        console.log("[Polyfill] getBrowserosVersionNumber called");
        if (callback) callback("0.0.0.35");
    };

    // Specific mock for getPref
    const originalGetPref = chrome.browserOS.getPref;
    chrome.browserOS.getPref = function (prefName, callback) {
        console.log("[Polyfill] getPref called for:", prefName);

        if (prefName === "browseros.server.agent_port") {
            if (callback) callback({ value: 9200 }); // Agent Port (DEFAULT)
            return;
        }
        if (prefName === "browseros.server.mcp_port") {
            if (callback) callback({ value: 9100 }); // MCP Port (DEFAULT)
            return;
        }
        if (prefName === "browseros.server.extension_port") {
            if (callback) callback({ value: 9300 }); // Controller Port (DEFAULT)
            return;
        }
        if (prefName === "browseros.server.allow_remote_in_mcp") {
            if (callback) callback({ value: true });
            return;
        }

        // Fallback to original if available, otherwise return null
        if (originalGetPref) {
            originalGetPref(prefName, callback);
        } else {
            if (callback) callback(null);
        }
    };

    // Robust Mock Creator
    function forceOverwrite(methodName, mockFn) {
        try {
            // Try simple assignment first
            chrome.browserOS[methodName] = mockFn;

            // Verify if it stuck
            if (chrome.browserOS[methodName] !== mockFn) {
                console.warn(`[Polyfill] Simple assignment failed for ${methodName}, trying defineProperty`);
                Object.defineProperty(chrome.browserOS, methodName, {
                    value: mockFn,
                    writable: true,
                    configurable: true,
                    enumerable: true
                });
            }
            console.log(`[Polyfill] Successfully mocked ${methodName}`);
        } catch (e) {
            console.error(`[Polyfill] Failed to overwrite ${methodName}:`, e);
        }
    }

    // Mock methods with proper return values
    const mockReturnValues = {
        getInteractiveSnapshot: { elements: [] },
        getPageLoadStatus: {
            isResourcesLoading: false,
            isDOMContentLoaded: true,
            isPageComplete: true
        },
        getAccessibilityTree: { nodes: [] },
        captureScreenshot: "data:image/png;base64,",
        getSnapshot: { text: "", links: [] },
        executeJavaScript: undefined,
        getAllPrefs: []
    };

    const mockMethods = [
        'getInteractiveSnapshot', 'click', 'inputText', 'clear', 'scrollToNode',
        'sendKeys', 'getPageLoadStatus', 'getAccessibilityTree', 'captureScreenshot',
        'getSnapshot', 'logMetric', 'executeJavaScript', 'clickCoordinates',
        'typeAtCoordinates', 'setPref', 'getAllPrefs'
    ];

    mockMethods.forEach(method => {
        forceOverwrite(method, function (...args) {
            console.log(`[Polyfill] chrome.browserOS.${method} called`, args);
            // Execute callback if last arg is function
            const lastArg = args[args.length - 1];
            if (typeof lastArg === 'function') {
                const returnValue = mockReturnValues[method] !== undefined
                    ? mockReturnValues[method]
                    : undefined;
                lastArg(returnValue);
            }
        });
    });

    // Mock chrome.topSites.get if missing (for New Tab Page)
    if (!chrome.topSites) {
        chrome.topSites = {};
    }
    if (!chrome.topSites.get) {
        chrome.topSites.get = function (callback) {
            console.log("[Polyfill] chrome.topSites.get called");
            if (callback) {
                callback([]);
                return;
            }
            return Promise.resolve([]);
        };
    }

    // Mock sidePanel.browserosToggle
    if (chrome.sidePanel && !chrome.sidePanel.browserosToggle) {
        chrome.sidePanel.browserosToggle = async function (args) {
            console.log("[Polyfill] chrome.sidePanel.browserosToggle called", args);
            try {
                if (args && args.tabId) {
                    await chrome.sidePanel.open({ tabId: args.tabId });
                } else {
                    const window = await chrome.windows.getLastFocused();
                    await chrome.sidePanel.open({ windowId: window.id });
                }
            } catch (e) {
                console.error("[Polyfill] Failed to toggle side panel", e);
            }
        };
    }

    // Mock sidePanel.browserosIsOpen
    if (chrome.sidePanel && !chrome.sidePanel.browserosIsOpen) {
        chrome.sidePanel.browserosIsOpen = async function () { return false; };
    }

})();
(()=>{"use strict";const e={protocol:"ws",host:"127.0.0.1",path:"/controller",defaultExtensionPort:9300,reconnectIntervalMs:5e3,heartbeatInterval:2e4,heartbeatTimeout:5e3,connectionTimeout:1e4,requestTimeout:3e4},t=1,r=1e3,n=!0,o="info",i="";const s=new class{constructor(e=i){this.prefix=e}log(e,t="info",r){if(!n)return;const i=(new Date).toISOString(),s=`${this.prefix} [${i}] ${e}`,a=r?`\n${JSON.stringify(r,null,2)}`:"";switch(t){case"debug":"debug"===o&&console.log(s+a);break;case"info":["debug","info"].includes(o)&&console.info(s+a);break;case"warn":["debug","info","warn"].includes(o)&&console.warn(s+a);break;case"error":console.error(s+a)}}debug(e,t){this.log(e,"debug",t)}info(e,t){this.log(e,"info",t)}warn(e,t){this.log(e,"warn",t)}error(e,t){this.log(e,"error",t)}};class a{constructor(){this.handlers=new Map}register(e,t){this.handlers.has(e)&&s.warn(`[ActionRegistry] Action "${e}" already registered, overwriting`),this.handlers.set(e,t),s.info(`[ActionRegistry] Registered action: ${e}`)}async dispatch(e,t){s.debug(`[ActionRegistry] Dispatching action: ${e}`);const r=this.handlers.get(e);if(!r){const t=`Unknown action: "${e}". Available actions: ${Array.from(this.handlers.keys()).join(", ")||"none"}`;return s.error(`[ActionRegistry] ${t}`),{ok:!1,error:t}}try{const n=await r.handle(t);return s.debug(`[ActionRegistry] Action "${e}" ${n.ok?"succeeded":"failed"}`),n}catch(t){const r=t instanceof Error?t.message:String(t);return s.error(`[ActionRegistry] Unexpected error in "${e}": ${r}`),{ok:!1,error:`Action execution failed: ${r}`}}}getAvailableActions(){return Array.from(this.handlers.keys())}hasAction(e){return this.handlers.has(e)}getActionCount(){return this.handlers.size}unregister(e){const t=this.handlers.delete(e);return t&&s.info(`[ActionRegistry] Unregistered action: ${e}`),t}clear(){const e=this.handlers.size;this.handlers.clear(),s.info(`[ActionRegistry] Cleared ${e} registered actions`)}}Object.freeze({status:"aborted"});function c(e,t,r){function n(r,n){var o;Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(o=r._zod).traits??(o.traits=new Set),r._zod.traits.add(e),t(r,n);for(const e in s.prototype)e in r||Object.defineProperty(r,e,{value:s.prototype[e].bind(r)});r._zod.constr=s,r._zod.def=n}const o=r?.Parent??Object;class i extends o{}function s(e){var t;const o=r?.Parent?new i:this;n(o,e),(t=o._zod).deferred??(t.deferred=[]);for(const e of o._zod.deferred)e();return o}return Object.defineProperty(i,"name",{value:e}),Object.defineProperty(s,"init",{value:n}),Object.defineProperty(s,Symbol.hasInstance,{value:t=>!!(r?.Parent&&t instanceof r.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}Symbol("zod_brand");class u extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class d extends Error{constructor(e){super(`Encountered unidirectional transform during encode: ${e}`),this.name="ZodEncodeError"}}const l={};function h(e){return e&&Object.assign(l,e),l}function p(e,t="|"){return e.map(e=>C(e)).join(t)}function m(e,t){return"bigint"==typeof t?t.toString():t}function g(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function f(e){return null==e}function w(e){const t=e.startsWith("^")?1:0,r=e.endsWith("$")?e.length-1:e.length;return e.slice(t,r)}const b=Symbol("evaluating");function y(e,t,r){let n;Object.defineProperty(e,t,{get(){if(n!==b)return void 0===n&&(n=b,n=r()),n},set(r){Object.defineProperty(e,t,{value:r})},configurable:!0})}function v(e,t,r){Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}function $(...e){const t={};for(const r of e){const e=Object.getOwnPropertyDescriptors(r);Object.assign(t,e)}return Object.defineProperties({},t)}function k(e){return JSON.stringify(e)}const S="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function _(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const A=g(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function E(e){if(!1===_(e))return!1;const t=e.constructor;if(void 0===t)return!0;const r=t.prototype;return!1!==_(r)&&!1!==Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")}function I(e){return E(e)?{...e}:Array.isArray(e)?[...e]:e}const z=new Set(["string","number","symbol"]);new Set(["string","number","bigint","boolean","symbol","undefined"]);function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function O(e,t,r){const n=new e._zod.constr(t??e._zod.def);return t&&!r?.parent||(n._zod.parent=e),n}function x(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}function C(e){return"bigint"==typeof e?e.toString()+"n":"string"==typeof e?`"${e}"`:`${e}`}const R={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function P(e,t=0){if(!0===e.aborted)return!0;for(let r=t;r<e.issues.length;r++)if(!0!==e.issues[r]?.continue)return!0;return!1}function F(e,t){return t.map(t=>{var r;return(r=t).path??(r.path=[]),t.path.unshift(e),t})}function N(e){return"string"==typeof e?e:e?.message}function Z(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const o=N(e.inst?._zod.def?.error?.(e))??N(t?.error?.(e))??N(r.customError?.(e))??N(r.localeError?.(e))??"Invalid input";n.message=o}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}function B(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function D(...e){const[t,r,n]=e;return"string"==typeof t?{message:t,code:"custom",input:r,inst:n}:{...t}}const q=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,m,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},U=c("$ZodError",q),j=c("$ZodError",q,{Parent:Error});const L=e=>(t,r,n,o)=>{const i=n?Object.assign(n,{async:!1}):{async:!1},s=t._zod.run({value:r,issues:[]},i);if(s instanceof Promise)throw new u;if(s.issues.length){const t=new(o?.Err??e)(s.issues.map(e=>Z(e,i,h())));throw S(t,o?.callee),t}return s.value},M=e=>async(t,r,n,o)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},i);if(s instanceof Promise&&(s=await s),s.issues.length){const t=new(o?.Err??e)(s.issues.map(e=>Z(e,i,h())));throw S(t,o?.callee),t}return s.value},H=e=>(t,r,n)=>{const o=n?{...n,async:!1}:{async:!1},i=t._zod.run({value:r,issues:[]},o);if(i instanceof Promise)throw new u;return i.issues.length?{success:!1,error:new(e??U)(i.issues.map(e=>Z(e,o,h())))}:{success:!0,data:i.value}},W=H(j),V=e=>async(t,r,n)=>{const o=n?Object.assign(n,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},o);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(e=>Z(e,o,h())))}:{success:!0,data:i.value}},J=V(j),G=e=>(t,r,n)=>{const o=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return L(e)(t,r,o)},Q=e=>(t,r,n)=>L(e)(t,r,n),K=e=>async(t,r,n)=>{const o=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return M(e)(t,r,o)},X=e=>async(t,r,n)=>M(e)(t,r,n),Y=e=>(t,r,n)=>{const o=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return H(e)(t,r,o)},ee=e=>(t,r,n)=>H(e)(t,r,n),te=e=>async(t,r,n)=>{const o=n?Object.assign(n,{direction:"backward"}):{direction:"backward"};return V(e)(t,r,o)},re=e=>async(t,r,n)=>V(e)(t,r,n),ne=/^[cC][^\s-]{8,}$/,oe=/^[0-9a-z]+$/,ie=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,se=/^[0-9a-vA-V]{20}$/,ae=/^[A-Za-z0-9]{27}$/,ce=/^[a-zA-Z0-9_-]{21}$/,ue=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,de=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,le=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,he=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;const pe=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,me=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,ge=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,fe=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,we=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,be=/^[A-Za-z0-9_-]*$/,ye=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,ve=/^\+(?:[0-9]){6,14}[0-9]$/,$e="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",ke=new RegExp(`^${$e}$`);function Se(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}const _e=/^-?\d+$/,Ae=/^-?\d+(?:\.\d+)?/,Ee=/^(?:true|false)$/i,Ie=/^[^A-Z]*$/,ze=/^[^a-z]*$/;const Te=c("$ZodCheck",(e,t)=>{var r;e._zod??(e._zod={}),e._zod.def=t,(r=e._zod).onattach??(r.onattach=[])}),Oe={number:"number",bigint:"bigint",object:"date"},xe=c("$ZodCheckLessThan",(e,t)=>{Te.init(e,t);const r=Oe[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.maximum:r.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<n&&(t.inclusive?r.maximum=t.value:r.exclusiveMaximum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value<=t.value:n.value<t.value)||n.issues.push({origin:r,code:"too_big",maximum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Ce=c("$ZodCheckGreaterThan",(e,t)=>{Te.init(e,t);const r=Oe[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.minimum:r.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>n&&(t.inclusive?r.minimum=t.value:r.exclusiveMinimum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value>=t.value:n.value>t.value)||n.issues.push({origin:r,code:"too_small",minimum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Re=c("$ZodCheckMultipleOf",(e,t)=>{Te.init(e,t),e._zod.onattach.push(e=>{var r;(r=e._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=r=>{if(typeof r.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof r.value?r.value%t.value===BigInt(0):0===function(e,t){const r=(e.toString().split(".")[1]||"").length,n=t.toString();let o=(n.split(".")[1]||"").length;if(0===o&&/\d?e-\d?/.test(n)){const e=n.match(/\d?e-(\d?)/);e?.[1]&&(o=Number.parseInt(e[1]))}const i=r>o?r:o;return Number.parseInt(e.toFixed(i).replace(".",""))%Number.parseInt(t.toFixed(i).replace(".",""))/10**i}(r.value,t.value))||r.issues.push({origin:typeof r.value,code:"not_multiple_of",divisor:t.value,input:r.value,inst:e,continue:!t.abort})}}),Pe=c("$ZodCheckNumberFormat",(e,t)=>{Te.init(e,t),t.format=t.format||"float64";const r=t.format?.includes("int"),n=r?"int":"number",[o,i]=R[t.format];e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=t.format,n.minimum=o,n.maximum=i,r&&(n.pattern=_e)}),e._zod.check=s=>{const a=s.value;if(r){if(!Number.isInteger(a))return void s.issues.push({expected:n,format:t.format,code:"invalid_type",continue:!1,input:a,inst:e});if(!Number.isSafeInteger(a))return void(a>0?s.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}):s.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}))}a<o&&s.issues.push({origin:"number",input:a,code:"too_small",minimum:o,inclusive:!0,inst:e,continue:!t.abort}),a>i&&s.issues.push({origin:"number",input:a,code:"too_big",maximum:i,inst:e})}}),Fe=c("$ZodCheckMaxLength",(e,t)=>{var r;Te.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!f(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<r&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const n=r.value;if(n.length<=t.maximum)return;const o=B(n);r.issues.push({origin:o,code:"too_big",maximum:t.maximum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),Ne=c("$ZodCheckMinLength",(e,t)=>{var r;Te.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!f(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>r&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const n=r.value;if(n.length>=t.minimum)return;const o=B(n);r.issues.push({origin:o,code:"too_small",minimum:t.minimum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),Ze=c("$ZodCheckLengthEquals",(e,t)=>{var r;Te.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!f(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag;r.minimum=t.length,r.maximum=t.length,r.length=t.length}),e._zod.check=r=>{const n=r.value,o=n.length;if(o===t.length)return;const i=B(n),s=o>t.length;r.issues.push({origin:i,...s?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),Be=c("$ZodCheckStringFormat",(e,t)=>{var r,n;Te.init(e,t),e._zod.onattach.push(e=>{const r=e._zod.bag;r.format=t.format,t.pattern&&(r.patterns??(r.patterns=new Set),r.patterns.add(t.pattern))}),t.pattern?(r=e._zod).check??(r.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:t.format,input:r.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(n=e._zod).check??(n.check=()=>{})}),De=c("$ZodCheckRegex",(e,t)=>{Be.init(e,t),e._zod.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:"regex",input:r.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),qe=c("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=Ie),Be.init(e,t)}),Ue=c("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=ze),Be.init(e,t)}),je=c("$ZodCheckIncludes",(e,t)=>{Te.init(e,t);const r=T(t.includes),n=new RegExp("number"==typeof t.position?`^.{${t.position}}${r}`:r);t.pattern=n,e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=r=>{r.value.includes(t.includes,t.position)||r.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:r.value,inst:e,continue:!t.abort})}}),Le=c("$ZodCheckStartsWith",(e,t)=>{Te.init(e,t);const r=new RegExp(`^${T(t.prefix)}.*`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.startsWith(t.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:r.value,inst:e,continue:!t.abort})}}),Me=c("$ZodCheckEndsWith",(e,t)=>{Te.init(e,t);const r=new RegExp(`.*${T(t.suffix)}$`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.endsWith(t.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:r.value,inst:e,continue:!t.abort})}});const He=c("$ZodCheckOverwrite",(e,t)=>{Te.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class We{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const t=e.split("\n").filter(e=>e),r=Math.min(...t.map(e=>e.length-e.trimStart().length)),n=t.map(e=>e.slice(r)).map(e=>" ".repeat(2*this.indent)+e);for(const e of n)this.content.push(e)}compile(){const e=Function,t=this?.args;return new e(...t,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}const Ve={major:4,minor:1,patch:12},Je=c("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Ve;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const t of n)for(const r of t._zod.onattach)r(e);if(0===n.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,r)=>{let n,o=P(e);for(const i of t){if(i._zod.def.when){if(!i._zod.def.when(e))continue}else if(o)continue;const t=e.issues.length,s=i._zod.check(e);if(s instanceof Promise&&!1===r?.async)throw new u;if(n||s instanceof Promise)n=(n??Promise.resolve()).then(async()=>{await s;e.issues.length!==t&&(o||(o=P(e,t)))});else{if(e.issues.length===t)continue;o||(o=P(e,t))}}return n?n.then(()=>e):e},r=(r,o,i)=>{if(P(r))return r.aborted=!0,r;const s=t(o,n,i);if(s instanceof Promise){if(!1===i.async)throw new u;return s.then(t=>e._zod.parse(t,i))}return e._zod.parse(s,i)};e._zod.run=(o,i)=>{if(i.skipChecks)return e._zod.parse(o,i);if("backward"===i.direction){const t=e._zod.parse({value:o.value,issues:[]},{...i,skipChecks:!0});return t instanceof Promise?t.then(e=>r(e,o,i)):r(t,o,i)}const s=e._zod.parse(o,i);if(s instanceof Promise){if(!1===i.async)throw new u;return s.then(e=>t(e,n,i))}return t(s,n,i)}}e["~standard"]={validate:t=>{try{const r=W(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch(r){return J(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),Ge=c("$ZodString",(e,t)=>{var r;Je.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(r=e._zod.bag,new RegExp(`^${r?`[\\s\\S]{${r?.minimum??0},${r?.maximum??""}}`:"[\\s\\S]*"}$`)),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=String(r.value)}catch(n){}return"string"==typeof r.value||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:e}),r}}),Qe=c("$ZodStringFormat",(e,t)=>{Be.init(e,t),Ge.init(e,t)}),Ke=c("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=de),Qe.init(e,t)}),Xe=c("$ZodUUID",(e,t)=>{if(t.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=le(e))}else t.pattern??(t.pattern=le());Qe.init(e,t)}),Ye=c("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=he),Qe.init(e,t)}),et=c("$ZodURL",(e,t)=>{Qe.init(e,t),e._zod.check=r=>{try{const n=r.value.trim(),o=new URL(n);return t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(o.hostname)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:ye.source,input:r.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(o.protocol.endsWith(":")?o.protocol.slice(0,-1):o.protocol)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:r.value,inst:e,continue:!t.abort})),void(t.normalize?r.value=o.href:r.value=n)}catch(n){r.issues.push({code:"invalid_format",format:"url",input:r.value,inst:e,continue:!t.abort})}}}),tt=c("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Qe.init(e,t)}),rt=c("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=ce),Qe.init(e,t)}),nt=c("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=ne),Qe.init(e,t)}),ot=c("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=oe),Qe.init(e,t)}),it=c("$ZodULID",(e,t)=>{t.pattern??(t.pattern=ie),Qe.init(e,t)}),st=c("$ZodXID",(e,t)=>{t.pattern??(t.pattern=se),Qe.init(e,t)}),at=c("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=ae),Qe.init(e,t)}),ct=c("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=function(e){const t=Se({precision:e.precision}),r=["Z"];e.local&&r.push(""),e.offset&&r.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const n=`${t}(?:${r.join("|")})`;return new RegExp(`^${$e}T(?:${n})$`)}(t)),Qe.init(e,t)}),ut=c("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=ke),Qe.init(e,t)}),dt=c("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=new RegExp(`^${Se(t)}$`)),Qe.init(e,t)}),lt=c("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=ue),Qe.init(e,t)}),ht=c("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=pe),Qe.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),pt=c("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=me),Qe.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=r=>{try{new URL(`http://[${r.value}]`)}catch{r.issues.push({code:"invalid_format",format:"ipv6",input:r.value,inst:e,continue:!t.abort})}}}),mt=c("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=ge),Qe.init(e,t)}),gt=c("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=fe),Qe.init(e,t),e._zod.check=r=>{const n=r.value.split("/");try{if(2!==n.length)throw new Error;const[e,t]=n;if(!t)throw new Error;const r=Number(t);if(`${r}`!==t)throw new Error;if(r<0||r>128)throw new Error;new URL(`http://[${e}]`)}catch{r.issues.push({code:"invalid_format",format:"cidrv6",input:r.value,inst:e,continue:!t.abort})}}});function ft(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const wt=c("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=we),Qe.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=r=>{ft(r.value)||r.issues.push({code:"invalid_format",format:"base64",input:r.value,inst:e,continue:!t.abort})}});const bt=c("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=be),Qe.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=r=>{(function(e){if(!be.test(e))return!1;const t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return ft(t.padEnd(4*Math.ceil(t.length/4),"="))})(r.value)||r.issues.push({code:"invalid_format",format:"base64url",input:r.value,inst:e,continue:!t.abort})}}),yt=c("$ZodE164",(e,t)=>{t.pattern??(t.pattern=ve),Qe.init(e,t)});const vt=c("$ZodJWT",(e,t)=>{Qe.init(e,t),e._zod.check=r=>{(function(e,t=null){try{const r=e.split(".");if(3!==r.length)return!1;const[n]=r;if(!n)return!1;const o=JSON.parse(atob(n));return!("typ"in o&&"JWT"!==o?.typ||!o.alg||t&&(!("alg"in o)||o.alg!==t))}catch{return!1}})(r.value,t.alg)||r.issues.push({code:"invalid_format",format:"jwt",input:r.value,inst:e,continue:!t.abort})}}),$t=c("$ZodNumber",(e,t)=>{Je.init(e,t),e._zod.pattern=e._zod.bag.pattern??Ae,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Number(r.value)}catch(e){}const o=r.value;if("number"==typeof o&&!Number.isNaN(o)&&Number.isFinite(o))return r;const i="number"==typeof o?Number.isNaN(o)?"NaN":Number.isFinite(o)?void 0:"Infinity":void 0;return r.issues.push({expected:"number",code:"invalid_type",input:o,inst:e,...i?{received:i}:{}}),r}}),kt=c("$ZodNumber",(e,t)=>{Pe.init(e,t),$t.init(e,t)}),St=c("$ZodBoolean",(e,t)=>{Je.init(e,t),e._zod.pattern=Ee,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Boolean(r.value)}catch(e){}const o=r.value;return"boolean"==typeof o||r.issues.push({expected:"boolean",code:"invalid_type",input:o,inst:e}),r}}),_t=c("$ZodAny",(e,t)=>{Je.init(e,t),e._zod.parse=e=>e}),At=c("$ZodUnknown",(e,t)=>{Je.init(e,t),e._zod.parse=e=>e}),Et=c("$ZodNever",(e,t)=>{Je.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function It(e,t,r){e.issues.length&&t.issues.push(...F(r,e.issues)),t.value[r]=e.value}const zt=c("$ZodArray",(e,t)=>{Je.init(e,t),e._zod.parse=(r,n)=>{const o=r.value;if(!Array.isArray(o))return r.issues.push({expected:"array",code:"invalid_type",input:o,inst:e}),r;r.value=Array(o.length);const i=[];for(let e=0;e<o.length;e++){const s=o[e],a=t.element._zod.run({value:s,issues:[]},n);a instanceof Promise?i.push(a.then(t=>It(t,r,e))):It(a,r,e)}return i.length?Promise.all(i).then(()=>r):r}});function Tt(e,t,r,n){e.issues.length&&t.issues.push(...F(r,e.issues)),void 0===e.value?r in n&&(t.value[r]=void 0):t.value[r]=e.value}function Ot(e){const t=Object.keys(e.shape);for(const r of t)if(!e.shape?.[r]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${r}": expected a Zod schema`);const r=(n=e.shape,Object.keys(n).filter(e=>"optional"===n[e]._zod.optin&&"optional"===n[e]._zod.optout));var n;return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(r)}}function xt(e,t,r,n,o,i){const s=[],a=o.keySet,c=o.catchall._zod,u=c.def.type;for(const o of Object.keys(t)){if(a.has(o))continue;if("never"===u){s.push(o);continue}const i=c.run({value:t[o],issues:[]},n);i instanceof Promise?e.push(i.then(e=>Tt(e,r,o,t))):Tt(i,r,o,t)}return s.length&&r.issues.push({code:"unrecognized_keys",keys:s,input:t,inst:i}),e.length?Promise.all(e).then(()=>r):r}const Ct=c("$ZodObject",(e,t)=>{Je.init(e,t);const r=Object.getOwnPropertyDescriptor(t,"shape");if(!r?.get){const e=t.shape;Object.defineProperty(t,"shape",{get:()=>{const r={...e};return Object.defineProperty(t,"shape",{value:r}),r}})}const n=g(()=>Ot(t));y(e._zod,"propValues",()=>{const e=t.shape,r={};for(const t in e){const n=e[t]._zod;if(n.values){r[t]??(r[t]=new Set);for(const e of n.values)r[t].add(e)}}return r});const o=_,i=t.catchall;let s;e._zod.parse=(t,r)=>{s??(s=n.value);const a=t.value;if(!o(a))return t.issues.push({expected:"object",code:"invalid_type",input:a,inst:e}),t;t.value={};const c=[],u=s.shape;for(const e of s.keys){const n=u[e]._zod.run({value:a[e],issues:[]},r);n instanceof Promise?c.push(n.then(r=>Tt(r,t,e,a))):Tt(n,t,e,a)}return i?xt(c,a,t,r,n.value,e):c.length?Promise.all(c).then(()=>t):t}}),Rt=c("$ZodObjectJIT",(e,t)=>{Ct.init(e,t);const r=e._zod.parse,n=g(()=>Ot(t));let o;const i=_,s=!l.jitless,a=s&&A.value,c=t.catchall;let u;e._zod.parse=(d,l)=>{u??(u=n.value);const h=d.value;return i(h)?s&&a&&!1===l?.async&&!0!==l.jitless?(o||(o=(e=>{const t=new We(["shape","payload","ctx"]),r=n.value,o=e=>{const t=k(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");const i=Object.create(null);let s=0;for(const e of r.keys)i[e]="key_"+s++;t.write("const newResult = {};");for(const e of r.keys){const r=i[e],n=k(e);t.write(`const ${r} = ${o(e)};`),t.write(`\n        if (${r}.issues.length) {\n          payload.issues = payload.issues.concat(${r}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${n}, ...iss.path] : [${n}]\n          })));\n        }\n        \n        \n        if (${r}.value === undefined) {\n          if (${n} in input) {\n            newResult[${n}] = undefined;\n          }\n        } else {\n          newResult[${n}] = ${r}.value;\n        }\n        \n      `)}t.write("payload.value = newResult;"),t.write("return payload;");const a=t.compile();return(t,r)=>a(e,t,r)})(t.shape)),d=o(d,l),c?xt([],h,d,l,u,e):d):r(d,l):(d.issues.push({expected:"object",code:"invalid_type",input:h,inst:e}),d)}});function Pt(e,t,r,n){for(const r of e)if(0===r.issues.length)return t.value=r.value,t;const o=e.filter(e=>!P(e));return 1===o.length?(t.value=o[0].value,o[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:r,errors:e.map(e=>e.issues.map(e=>Z(e,n,h())))}),t)}const Ft=c("$ZodUnion",(e,t)=>{Je.init(e,t),y(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),y(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),y(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),y(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){const e=t.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>w(e.source)).join("|")})$`)}});const r=1===t.options.length,n=t.options[0]._zod.run;e._zod.parse=(o,i)=>{if(r)return n(o,i);let s=!1;const a=[];for(const e of t.options){const t=e._zod.run({value:o.value,issues:[]},i);if(t instanceof Promise)a.push(t),s=!0;else{if(0===t.issues.length)return t;a.push(t)}}return s?Promise.all(a).then(t=>Pt(t,o,e,i)):Pt(a,o,e,i)}}),Nt=c("$ZodIntersection",(e,t)=>{Je.init(e,t),e._zod.parse=(e,r)=>{const n=e.value,o=t.left._zod.run({value:n,issues:[]},r),i=t.right._zod.run({value:n,issues:[]},r);return o instanceof Promise||i instanceof Promise?Promise.all([o,i]).then(([t,r])=>Bt(e,t,r)):Bt(e,o,i)}});function Zt(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e===+t)return{valid:!0,data:e};if(E(e)&&E(t)){const r=Object.keys(t),n=Object.keys(e).filter(e=>-1!==r.indexOf(e)),o={...e,...t};for(const r of n){const n=Zt(e[r],t[r]);if(!n.valid)return{valid:!1,mergeErrorPath:[r,...n.mergeErrorPath]};o[r]=n.data}return{valid:!0,data:o}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<e.length;n++){const o=Zt(e[n],t[n]);if(!o.valid)return{valid:!1,mergeErrorPath:[n,...o.mergeErrorPath]};r.push(o.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function Bt(e,t,r){if(t.issues.length&&e.issues.push(...t.issues),r.issues.length&&e.issues.push(...r.issues),P(e))return e;const n=Zt(t.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return e.value=n.data,e}const Dt=c("$ZodEnum",(e,t)=>{Je.init(e,t);const r=function(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,r])=>-1===t.indexOf(+e)).map(([e,t])=>t)}(t.entries),n=new Set(r);e._zod.values=n,e._zod.pattern=new RegExp(`^(${r.filter(e=>z.has(typeof e)).map(e=>"string"==typeof e?T(e):e.toString()).join("|")})$`),e._zod.parse=(t,o)=>{const i=t.value;return n.has(i)||t.issues.push({code:"invalid_value",values:r,input:i,inst:e}),t}}),qt=c("$ZodTransform",(e,t)=>{Je.init(e,t),e._zod.parse=(r,n)=>{if("backward"===n.direction)throw new d(e.constructor.name);const o=t.transform(r.value,r);if(n.async){return(o instanceof Promise?o:Promise.resolve(o)).then(e=>(r.value=e,r))}if(o instanceof Promise)throw new u;return r.value=o,r}});function Ut(e,t){return e.issues.length&&void 0===t?{issues:[],value:void 0}:e}const jt=c("$ZodOptional",(e,t)=>{Je.init(e,t),e._zod.optin="optional",e._zod.optout="optional",y(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),y(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${w(e.source)})?$`):void 0}),e._zod.parse=(e,r)=>{if("optional"===t.innerType._zod.optin){const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(t=>Ut(t,e.value)):Ut(n,e.value)}return void 0===e.value?e:t.innerType._zod.run(e,r)}}),Lt=c("$ZodNullable",(e,t)=>{Je.init(e,t),y(e._zod,"optin",()=>t.innerType._zod.optin),y(e._zod,"optout",()=>t.innerType._zod.optout),y(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${w(e.source)}|null)$`):void 0}),y(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,r)=>null===e.value?e:t.innerType._zod.run(e,r)}),Mt=c("$ZodDefault",(e,t)=>{Je.init(e,t),e._zod.optin="optional",y(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{if("backward"===r.direction)return t.innerType._zod.run(e,r);if(void 0===e.value)return e.value=t.defaultValue,e;const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(e=>Ht(e,t)):Ht(n,t)}});function Ht(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}const Wt=c("$ZodPrefault",(e,t)=>{Je.init(e,t),e._zod.optin="optional",y(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>("backward"===r.direction||void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,r))}),Vt=c("$ZodNonOptional",(e,t)=>{Je.init(e,t),y(e._zod,"values",()=>{const e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(r,n)=>{const o=t.innerType._zod.run(r,n);return o instanceof Promise?o.then(t=>Jt(t,e)):Jt(o,e)}});function Jt(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const Gt=c("$ZodCatch",(e,t)=>{Je.init(e,t),y(e._zod,"optin",()=>t.innerType._zod.optin),y(e._zod,"optout",()=>t.innerType._zod.optout),y(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{if("backward"===r.direction)return t.innerType._zod.run(e,r);const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(n=>(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>Z(e,r,h()))},input:e.value}),e.issues=[]),e)):(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>Z(e,r,h()))},input:e.value}),e.issues=[]),e)}}),Qt=c("$ZodPipe",(e,t)=>{Je.init(e,t),y(e._zod,"values",()=>t.in._zod.values),y(e._zod,"optin",()=>t.in._zod.optin),y(e._zod,"optout",()=>t.out._zod.optout),y(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(e,r)=>{if("backward"===r.direction){const n=t.out._zod.run(e,r);return n instanceof Promise?n.then(e=>Kt(e,t.in,r)):Kt(n,t.in,r)}const n=t.in._zod.run(e,r);return n instanceof Promise?n.then(e=>Kt(e,t.out,r)):Kt(n,t.out,r)}});function Kt(e,t,r){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},r)}const Xt=c("$ZodReadonly",(e,t)=>{Je.init(e,t),y(e._zod,"propValues",()=>t.innerType._zod.propValues),y(e._zod,"values",()=>t.innerType._zod.values),y(e._zod,"optin",()=>t.innerType._zod.optin),y(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(e,r)=>{if("backward"===r.direction)return t.innerType._zod.run(e,r);const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(Yt):Yt(n)}});function Yt(e){return e.value=Object.freeze(e.value),e}const er=c("$ZodCustom",(e,t)=>{Te.init(e,t),Je.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=r=>{const n=r.value,o=t.fn(n);if(o instanceof Promise)return o.then(t=>tr(t,r,n,e));tr(o,r,n,e)}});function tr(e,t,r,n){if(!e){const e={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(e.params=n._zod.def.params),t.issues.push(D(e))}}const rr=()=>{const e={string:{unit:"characters",verb:"to have"},file:{unit:"bytes",verb:"to have"},array:{unit:"items",verb:"to have"},set:{unit:"items",verb:"to have"}};function t(t){return e[t]??null}const r={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Invalid input: expected ${e.expected}, received ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Invalid input: expected ${C(e.values[0])}`:`Invalid option: expected one of ${p(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Too big: expected ${e.origin??"value"} to have ${r}${e.maximum.toString()} ${n.unit??"elements"}`:`Too big: expected ${e.origin??"value"} to be ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Too small: expected ${e.origin} to have ${r}${e.minimum.toString()} ${n.unit}`:`Too small: expected ${e.origin} to be ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Invalid string: must start with "${t.prefix}"`:"ends_with"===t.format?`Invalid string: must end with "${t.suffix}"`:"includes"===t.format?`Invalid string: must include "${t.includes}"`:"regex"===t.format?`Invalid string: must match pattern ${t.pattern}`:`Invalid ${r[t.format]??e.format}`}case"not_multiple_of":return`Invalid number: must be a multiple of ${e.divisor}`;case"unrecognized_keys":return`Unrecognized key${e.keys.length>1?"s":""}: ${p(e.keys,", ")}`;case"invalid_key":return`Invalid key in ${e.origin}`;case"invalid_union":default:return"Invalid input";case"invalid_element":return`Invalid value in ${e.origin}`}}};Symbol("ZodOutput"),Symbol("ZodInput");class nr{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};delete r.id;const n={...r,...this._map.get(e)};return Object.keys(n).length?n:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function or(){return new nr}const ir=or();function sr(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...x(t)})}function ar(e,t){return new xe({check:"less_than",...x(t),value:e,inclusive:!1})}function cr(e,t){return new xe({check:"less_than",...x(t),value:e,inclusive:!0})}function ur(e,t){return new Ce({check:"greater_than",...x(t),value:e,inclusive:!1})}function dr(e,t){return new Ce({check:"greater_than",...x(t),value:e,inclusive:!0})}function lr(e,t){return new Re({check:"multiple_of",...x(t),value:e})}function hr(e,t){return new Fe({check:"max_length",...x(t),maximum:e})}function pr(e,t){return new Ne({check:"min_length",...x(t),minimum:e})}function mr(e,t){return new Ze({check:"length_equals",...x(t),length:e})}function gr(e){return new He({check:"overwrite",tx:e})}function fr(e){const t=function(e,t){const r=new Te({check:"custom",...x(t)});return r._zod.check=e,r}(r=>(r.addIssue=e=>{if("string"==typeof e)r.issues.push(D(e,r.value,t._zod.def));else{const n=e;n.fatal&&(n.continue=!1),n.code??(n.code="custom"),n.input??(n.input=r.value),n.inst??(n.inst=t),n.continue??(n.continue=!t._zod.def.abort),r.issues.push(D(n))}},e(r.value,r)));return t}const wr=c("ZodISODateTime",(e,t)=>{ct.init(e,t),Mr.init(e,t)});function br(e){return function(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...x(t)})}(wr,e)}const yr=c("ZodISODate",(e,t)=>{ut.init(e,t),Mr.init(e,t)});function vr(e){return function(e,t){return new e({type:"string",format:"date",check:"string_format",...x(t)})}(yr,e)}const $r=c("ZodISOTime",(e,t)=>{dt.init(e,t),Mr.init(e,t)});function kr(e){return function(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...x(t)})}($r,e)}const Sr=c("ZodISODuration",(e,t)=>{lt.init(e,t),Mr.init(e,t)});function _r(e){return function(e,t){return new e({type:"string",format:"duration",check:"string_format",...x(t)})}(Sr,e)}const Ar=(e,t)=>{U.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>function(e,t=e=>e.message){const r={_errors:[]},n=e=>{for(const o of e.issues)if("invalid_union"===o.code&&o.errors.length)o.errors.map(e=>n({issues:e}));else if("invalid_key"===o.code)n({issues:o.issues});else if("invalid_element"===o.code)n({issues:o.issues});else if(0===o.path.length)r._errors.push(t(o));else{let e=r,n=0;for(;n<o.path.length;){const r=o.path[n];n===o.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(o))):e[r]=e[r]||{_errors:[]},e=e[r],n++}}};return n(e),r}(e,t)},flatten:{value:t=>function(e,t=e=>e.message){const r={},n=[];for(const o of e.issues)o.path.length>0?(r[o.path[0]]=r[o.path[0]]||[],r[o.path[0]].push(t(o))):n.push(t(o));return{formErrors:n,fieldErrors:r}}(e,t)},addIssue:{value:t=>{e.issues.push(t),e.message=JSON.stringify(e.issues,m,2)}},addIssues:{value:t=>{e.issues.push(...t),e.message=JSON.stringify(e.issues,m,2)}},isEmpty:{get:()=>0===e.issues.length}})},Er=c("ZodError",Ar),Ir=c("ZodError",Ar,{Parent:Error}),zr=L(Ir),Tr=M(Ir),Or=H(Ir),xr=V(Ir),Cr=G(Ir),Rr=Q(Ir),Pr=K(Ir),Fr=X(Ir),Nr=Y(Ir),Zr=ee(Ir),Br=te(Ir),Dr=re(Ir),qr=c("ZodType",(e,t)=>(Je.init(e,t),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone($(t,{checks:[...t.checks??[],...r.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]})),e.clone=(t,r)=>O(e,t,r),e.brand=()=>e,e.register=(t,r)=>(t.add(e,r),e),e.parse=(t,r)=>zr(e,t,r,{callee:e.parse}),e.safeParse=(t,r)=>Or(e,t,r),e.parseAsync=async(t,r)=>Tr(e,t,r,{callee:e.parseAsync}),e.safeParseAsync=async(t,r)=>xr(e,t,r),e.spa=e.safeParseAsync,e.encode=(t,r)=>Cr(e,t,r),e.decode=(t,r)=>Rr(e,t,r),e.encodeAsync=async(t,r)=>Pr(e,t,r),e.decodeAsync=async(t,r)=>Fr(e,t,r),e.safeEncode=(t,r)=>Nr(e,t,r),e.safeDecode=(t,r)=>Zr(e,t,r),e.safeEncodeAsync=async(t,r)=>Br(e,t,r),e.safeDecodeAsync=async(t,r)=>Dr(e,t,r),e.refine=(t,r)=>e.check(function(e,t={}){return function(e,t,r){return new e({type:"custom",check:"custom",fn:t,...x(r)})}(Hn,e,t)}(t,r)),e.superRefine=t=>e.check(fr(t)),e.overwrite=t=>e.check(gr(t)),e.optional=()=>Fn(e),e.nullable=()=>Zn(e),e.nullish=()=>Fn(Zn(e)),e.nonoptional=t=>function(e,t){return new qn({type:"nonoptional",innerType:e,...x(t)})}(e,t),e.array=()=>_n(e),e.or=t=>zn([e,t]),e.and=t=>new Tn({type:"intersection",left:e,right:t}),e.transform=t=>Ln(e,Rn(t)),e.default=t=>{return r=t,new Bn({type:"default",innerType:e,get defaultValue(){return"function"==typeof r?r():I(r)}});var r},e.prefault=t=>{return r=t,new Dn({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof r?r():I(r)}});var r},e.catch=t=>{return new Un({type:"catch",innerType:e,catchValue:"function"==typeof(r=t)?r:()=>r});var r},e.pipe=t=>Ln(e,t),e.readonly=()=>new Mn({type:"readonly",innerType:e}),e.describe=t=>{const r=e.clone();return ir.add(r,{description:t}),r},Object.defineProperty(e,"description",{get:()=>ir.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return ir.get(e);const r=e.clone();return ir.add(r,t[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),Ur=c("_ZodString",(e,t)=>{Ge.init(e,t),qr.init(e,t);const r=e._zod.bag;e.format=r.format??null,e.minLength=r.minimum??null,e.maxLength=r.maximum??null,e.regex=(...t)=>e.check(function(e,t){return new De({check:"string_format",format:"regex",...x(t),pattern:e})}(...t)),e.includes=(...t)=>e.check(function(e,t){return new je({check:"string_format",format:"includes",...x(t),includes:e})}(...t)),e.startsWith=(...t)=>e.check(function(e,t){return new Le({check:"string_format",format:"starts_with",...x(t),prefix:e})}(...t)),e.endsWith=(...t)=>e.check(function(e,t){return new Me({check:"string_format",format:"ends_with",...x(t),suffix:e})}(...t)),e.min=(...t)=>e.check(pr(...t)),e.max=(...t)=>e.check(hr(...t)),e.length=(...t)=>e.check(mr(...t)),e.nonempty=(...t)=>e.check(pr(1,...t)),e.lowercase=t=>e.check(function(e){return new qe({check:"string_format",format:"lowercase",...x(e)})}(t)),e.uppercase=t=>e.check(function(e){return new Ue({check:"string_format",format:"uppercase",...x(e)})}(t)),e.trim=()=>e.check(gr(e=>e.trim())),e.normalize=(...t)=>e.check(function(e){return gr(t=>t.normalize(e))}(...t)),e.toLowerCase=()=>e.check(gr(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(gr(e=>e.toUpperCase()))}),jr=c("ZodString",(e,t)=>{Ge.init(e,t),Ur.init(e,t),e.email=t=>e.check(function(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...x(t)})}(Hr,t)),e.url=t=>e.check(function(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...x(t)})}(Jr,t)),e.jwt=t=>e.check(function(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...x(t)})}(dn,t)),e.emoji=t=>e.check(function(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...x(t)})}(Gr,t)),e.guid=t=>e.check(sr(Wr,t)),e.uuid=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...x(t)})}(Vr,t)),e.uuidv4=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...x(t)})}(Vr,t)),e.uuidv6=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...x(t)})}(Vr,t)),e.uuidv7=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...x(t)})}(Vr,t)),e.nanoid=t=>e.check(function(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...x(t)})}(Qr,t)),e.guid=t=>e.check(sr(Wr,t)),e.cuid=t=>e.check(function(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...x(t)})}(Kr,t)),e.cuid2=t=>e.check(function(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...x(t)})}(Xr,t)),e.ulid=t=>e.check(function(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...x(t)})}(Yr,t)),e.base64=t=>e.check(function(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...x(t)})}(an,t)),e.base64url=t=>e.check(function(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...x(t)})}(cn,t)),e.xid=t=>e.check(function(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...x(t)})}(en,t)),e.ksuid=t=>e.check(function(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...x(t)})}(tn,t)),e.ipv4=t=>e.check(function(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...x(t)})}(rn,t)),e.ipv6=t=>e.check(function(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...x(t)})}(nn,t)),e.cidrv4=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...x(t)})}(on,t)),e.cidrv6=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...x(t)})}(sn,t)),e.e164=t=>e.check(function(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...x(t)})}(un,t)),e.datetime=t=>e.check(br(t)),e.date=t=>e.check(vr(t)),e.time=t=>e.check(kr(t)),e.duration=t=>e.check(_r(t))});function Lr(e){return function(e,t){return new e({type:"string",...x(t)})}(jr,e)}const Mr=c("ZodStringFormat",(e,t)=>{Qe.init(e,t),Ur.init(e,t)}),Hr=c("ZodEmail",(e,t)=>{Ye.init(e,t),Mr.init(e,t)});const Wr=c("ZodGUID",(e,t)=>{Ke.init(e,t),Mr.init(e,t)});const Vr=c("ZodUUID",(e,t)=>{Xe.init(e,t),Mr.init(e,t)});const Jr=c("ZodURL",(e,t)=>{et.init(e,t),Mr.init(e,t)});const Gr=c("ZodEmoji",(e,t)=>{tt.init(e,t),Mr.init(e,t)});const Qr=c("ZodNanoID",(e,t)=>{rt.init(e,t),Mr.init(e,t)});const Kr=c("ZodCUID",(e,t)=>{nt.init(e,t),Mr.init(e,t)});const Xr=c("ZodCUID2",(e,t)=>{ot.init(e,t),Mr.init(e,t)});const Yr=c("ZodULID",(e,t)=>{it.init(e,t),Mr.init(e,t)});const en=c("ZodXID",(e,t)=>{st.init(e,t),Mr.init(e,t)});const tn=c("ZodKSUID",(e,t)=>{at.init(e,t),Mr.init(e,t)});const rn=c("ZodIPv4",(e,t)=>{ht.init(e,t),Mr.init(e,t)});const nn=c("ZodIPv6",(e,t)=>{pt.init(e,t),Mr.init(e,t)});const on=c("ZodCIDRv4",(e,t)=>{mt.init(e,t),Mr.init(e,t)});const sn=c("ZodCIDRv6",(e,t)=>{gt.init(e,t),Mr.init(e,t)});const an=c("ZodBase64",(e,t)=>{wt.init(e,t),Mr.init(e,t)});const cn=c("ZodBase64URL",(e,t)=>{bt.init(e,t),Mr.init(e,t)});const un=c("ZodE164",(e,t)=>{yt.init(e,t),Mr.init(e,t)});const dn=c("ZodJWT",(e,t)=>{vt.init(e,t),Mr.init(e,t)});const ln=c("ZodNumber",(e,t)=>{$t.init(e,t),qr.init(e,t),e.gt=(t,r)=>e.check(ur(t,r)),e.gte=(t,r)=>e.check(dr(t,r)),e.min=(t,r)=>e.check(dr(t,r)),e.lt=(t,r)=>e.check(ar(t,r)),e.lte=(t,r)=>e.check(cr(t,r)),e.max=(t,r)=>e.check(cr(t,r)),e.int=t=>e.check(mn(t)),e.safe=t=>e.check(mn(t)),e.positive=t=>e.check(ur(0,t)),e.nonnegative=t=>e.check(dr(0,t)),e.negative=t=>e.check(ar(0,t)),e.nonpositive=t=>e.check(cr(0,t)),e.multipleOf=(t,r)=>e.check(lr(t,r)),e.step=(t,r)=>e.check(lr(t,r)),e.finite=()=>e;const r=e._zod.bag;e.minValue=Math.max(r.minimum??Number.NEGATIVE_INFINITY,r.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(r.maximum??Number.POSITIVE_INFINITY,r.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(r.format??"").includes("int")||Number.isSafeInteger(r.multipleOf??.5),e.isFinite=!0,e.format=r.format??null});function hn(e){return function(e,t){return new e({type:"number",checks:[],...x(t)})}(ln,e)}const pn=c("ZodNumberFormat",(e,t)=>{kt.init(e,t),ln.init(e,t)});function mn(e){return function(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...x(t)})}(pn,e)}const gn=c("ZodBoolean",(e,t)=>{St.init(e,t),qr.init(e,t)});function fn(e){return function(e,t){return new e({type:"boolean",...x(t)})}(gn,e)}const wn=c("ZodAny",(e,t)=>{_t.init(e,t),qr.init(e,t)});function bn(){return function(e){return new e({type:"any"})}(wn)}const yn=c("ZodUnknown",(e,t)=>{At.init(e,t),qr.init(e,t)});function vn(){return function(e){return new e({type:"unknown"})}(yn)}const $n=c("ZodNever",(e,t)=>{Et.init(e,t),qr.init(e,t)});function kn(e){return function(e,t){return new e({type:"never",...x(t)})}($n,e)}const Sn=c("ZodArray",(e,t)=>{zt.init(e,t),qr.init(e,t),e.element=t.element,e.min=(t,r)=>e.check(pr(t,r)),e.nonempty=t=>e.check(pr(1,t)),e.max=(t,r)=>e.check(hr(t,r)),e.length=(t,r)=>e.check(mr(t,r)),e.unwrap=()=>e.element});function _n(e,t){return function(e,t,r){return new e({type:"array",element:t,...x(r)})}(Sn,e,t)}const An=c("ZodObject",(e,t)=>{Rt.init(e,t),qr.init(e,t),y(e,"shape",()=>t.shape),e.keyof=()=>xn(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:vn()}),e.loose=()=>e.clone({...e._zod.def,catchall:vn()}),e.strict=()=>e.clone({...e._zod.def,catchall:kn()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>function(e,t){if(!E(t))throw new Error("Invalid input to extend: expected a plain object");const r=e._zod.def.checks;if(r&&r.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const n=$(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t};return v(this,"shape",r),r},checks:[]});return O(e,n)}(e,t),e.safeExtend=t=>function(e,t){if(!E(t))throw new Error("Invalid input to safeExtend: expected a plain object");const r={...e._zod.def,get shape(){const r={...e._zod.def.shape,...t};return v(this,"shape",r),r},checks:e._zod.def.checks};return O(e,r)}(e,t),e.merge=t=>function(e,t){const r=$(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return v(this,"shape",r),r},get catchall(){return t._zod.def.catchall},checks:[]});return O(e,r)}(e,t),e.pick=t=>function(e,t){const r=e._zod.def;return O(e,$(e._zod.def,{get shape(){const e={};for(const n in t){if(!(n in r.shape))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(e[n]=r.shape[n])}return v(this,"shape",e),e},checks:[]}))}(e,t),e.omit=t=>function(e,t){const r=e._zod.def,n=$(e._zod.def,{get shape(){const n={...e._zod.def.shape};for(const e in t){if(!(e in r.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&delete n[e]}return v(this,"shape",n),n},checks:[]});return O(e,n)}(e,t),e.partial=(...t)=>function(e,t,r){const n=$(t._zod.def,{get shape(){const n=t._zod.def.shape,o={...n};if(r)for(const t in r){if(!(t in n))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(o[t]=e?new e({type:"optional",innerType:n[t]}):n[t])}else for(const t in n)o[t]=e?new e({type:"optional",innerType:n[t]}):n[t];return v(this,"shape",o),o},checks:[]});return O(t,n)}(Pn,e,t[0]),e.required=(...t)=>function(e,t,r){const n=$(t._zod.def,{get shape(){const n=t._zod.def.shape,o={...n};if(r)for(const t in r){if(!(t in o))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(o[t]=new e({type:"nonoptional",innerType:n[t]}))}else for(const t in n)o[t]=new e({type:"nonoptional",innerType:n[t]});return v(this,"shape",o),o},checks:[]});return O(t,n)}(qn,e,t[0])});function En(e,t){const r={type:"object",shape:e??{},...x(t)};return new An(r)}const In=c("ZodUnion",(e,t)=>{Ft.init(e,t),qr.init(e,t),e.options=t.options});function zn(e,t){return new In({type:"union",options:e,...x(t)})}const Tn=c("ZodIntersection",(e,t)=>{Nt.init(e,t),qr.init(e,t)});const On=c("ZodEnum",(e,t)=>{Dt.init(e,t),qr.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(e,n)=>{const o={};for(const n of e){if(!r.has(n))throw new Error(`Key ${n} not found in enum`);o[n]=t.entries[n]}return new On({...t,checks:[],...x(n),entries:o})},e.exclude=(e,n)=>{const o={...t.entries};for(const t of e){if(!r.has(t))throw new Error(`Key ${t} not found in enum`);delete o[t]}return new On({...t,checks:[],...x(n),entries:o})}});function xn(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new On({type:"enum",entries:r,...x(t)})}const Cn=c("ZodTransform",(e,t)=>{qt.init(e,t),qr.init(e,t),e._zod.parse=(r,n)=>{if("backward"===n.direction)throw new d(e.constructor.name);r.addIssue=n=>{if("string"==typeof n)r.issues.push(D(n,r.value,t));else{const t=n;t.fatal&&(t.continue=!1),t.code??(t.code="custom"),t.input??(t.input=r.value),t.inst??(t.inst=e),r.issues.push(D(t))}};const o=t.transform(r.value,r);return o instanceof Promise?o.then(e=>(r.value=e,r)):(r.value=o,r)}});function Rn(e){return new Cn({type:"transform",transform:e})}const Pn=c("ZodOptional",(e,t)=>{jt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Fn(e){return new Pn({type:"optional",innerType:e})}const Nn=c("ZodNullable",(e,t)=>{Lt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Zn(e){return new Nn({type:"nullable",innerType:e})}const Bn=c("ZodDefault",(e,t)=>{Mt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});const Dn=c("ZodPrefault",(e,t)=>{Wt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType});const qn=c("ZodNonOptional",(e,t)=>{Vt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType});const Un=c("ZodCatch",(e,t)=>{Gt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});const jn=c("ZodPipe",(e,t)=>{Qt.init(e,t),qr.init(e,t),e.in=t.in,e.out=t.out});function Ln(e,t){return new jn({type:"pipe",in:e,out:t})}const Mn=c("ZodReadonly",(e,t)=>{Xt.init(e,t),qr.init(e,t),e.unwrap=()=>e._zod.def.innerType});const Hn=c("ZodCustom",(e,t)=>{er.init(e,t),qr.init(e,t)});var Wn;Wn||(Wn={}),h({localeError:rr()});const Vn=En({id:Lr().describe("Request UUID"),action:Lr().min(1).describe("Action name"),payload:bn().optional().describe("Action-specific data")});En({id:Lr().describe("Request ID (same as request)"),ok:fn().describe("Success flag"),data:bn().optional().describe("Result data"),error:Lr().optional().describe("Error message")}),En({ok:fn().describe("Success flag"),data:bn().optional().describe("Result data"),error:Lr().optional().describe("Error message")}).refine(e=>(!e.ok||void 0===e.error)&&!(!e.ok&&!e.error),{message:"When ok is true, error must be undefined. When ok is false, error must be provided."});var Jn;!function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.ERROR="error"}(Jn||(Jn={}));class Gn{async handle(e){const t=this.constructor.name;try{s.debug(`[${t}] Validating input`);const r=this.inputSchema.parse(e);s.debug(`[${t}] Executing action`);const n=await this.execute(r);return s.debug(`[${t}] Action completed successfully`),{ok:!0,data:n}}catch(e){const r=this._formatError(e);return s.error(`[${t}] Action failed: ${r}`),{ok:!1,error:r}}}_formatError(e){if(e instanceof Er){return`Validation error: ${e.issues.map(e=>`${e.path.length>0?`${e.path.join(".")}: `:""}${e.message}`).join(", ")}`}return e instanceof Error?e.message:String(e)}}class Qn{async getBookmarkTree(){s.debug("[BookmarkAdapter] Getting bookmark tree");try{const e=await chrome.bookmarks.getTree();return s.debug(`[BookmarkAdapter] Retrieved bookmark tree with ${e.length} root nodes`),e}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BookmarkAdapter] Failed to get bookmark tree: ${t}`),new Error(`Failed to get bookmark tree: ${t}`)}}async searchBookmarks(e){s.debug(`[BookmarkAdapter] Searching bookmarks: "${e}"`);try{const t=await chrome.bookmarks.search(e);return s.debug(`[BookmarkAdapter] Found ${t.length} bookmarks matching "${e}"`),t}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BookmarkAdapter] Failed to search bookmarks: ${t}`),new Error(`Failed to search bookmarks: ${t}`)}}async getBookmark(e){s.debug(`[BookmarkAdapter] Getting bookmark: ${e}`);try{const t=await chrome.bookmarks.get(e);if(0===t.length)throw new Error("Bookmark not found");return s.debug(`[BookmarkAdapter] Retrieved bookmark: ${e}`),t[0]}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BookmarkAdapter] Failed to get bookmark: ${t}`),new Error(`Failed to get bookmark: ${t}`)}}async createBookmark(e){s.debug(`[BookmarkAdapter] Creating bookmark: ${e.title||"Untitled"}`);try{const t=await chrome.bookmarks.create(e);return s.debug(`[BookmarkAdapter] Created bookmark: ${t.id} - ${t.title}`),t}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BookmarkAdapter] Failed to create bookmark: ${t}`),new Error(`Failed to create bookmark: ${t}`)}}async removeBookmark(e){s.debug(`[BookmarkAdapter] Removing bookmark: ${e}`);try{await chrome.bookmarks.remove(e),s.debug(`[BookmarkAdapter] Removed bookmark: ${e}`)}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[BookmarkAdapter] Failed to remove bookmark ${e}: ${r}`),new Error(`Failed to remove bookmark: ${r}`)}}async updateBookmark(e,t){s.debug(`[BookmarkAdapter] Updating bookmark: ${e}`);try{const r=await chrome.bookmarks.update(e,t);return s.debug(`[BookmarkAdapter] Updated bookmark: ${e} - ${r.title}`),r}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[BookmarkAdapter] Failed to update bookmark ${e}: ${r}`),new Error(`Failed to update bookmark: ${r}`)}}async getRecentBookmarks(e=20){s.debug(`[BookmarkAdapter] Getting ${e} recent bookmarks`);try{const t=await chrome.bookmarks.getTree(),r=this._flattenBookmarkTree(t).filter(e=>e.url&&e.dateAdded).sort((e,t)=>(t.dateAdded||0)-(e.dateAdded||0)).slice(0,e);return s.debug(`[BookmarkAdapter] Found ${r.length} recent bookmarks`),r}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BookmarkAdapter] Failed to get recent bookmarks: ${t}`),new Error(`Failed to get recent bookmarks: ${t}`)}}_flattenBookmarkTree(e){const t=[];for(const r of e)t.push(r),r.children&&t.push(...this._flattenBookmarkTree(r.children));return t}}const Kn=En({title:Lr().describe("Bookmark title"),url:Lr().url().describe("Bookmark URL"),parentId:Lr().optional().describe('Parent folder ID (optional, defaults to "Other Bookmarks")')});En({id:Lr().describe("Created bookmark ID"),title:Lr().describe("Bookmark title"),url:Lr().describe("Bookmark URL"),dateAdded:hn().optional().describe("Timestamp when bookmark was created")});class Xn extends Gn{constructor(){super(...arguments),this.inputSchema=Kn,this.bookmarkAdapter=new Qn}async execute(e){const t=await this.bookmarkAdapter.createBookmark({title:e.title,url:e.url,parentId:e.parentId});return{id:t.id,title:t.title,url:t.url||"",dateAdded:t.dateAdded}}}const Yn=En({query:Lr().optional().describe("Search query to filter bookmarks (optional, returns all if not provided)"),limit:hn().int().positive().optional().default(20).describe("Maximum number of results (default: 20)"),recent:fn().optional().default(!1).describe("Get recent bookmarks instead of searching")});En({bookmarks:_n(En({id:Lr(),title:Lr(),url:Lr().optional(),dateAdded:hn().optional(),parentId:Lr().optional()})),count:hn()});class eo extends Gn{constructor(){super(...arguments),this.inputSchema=Yn,this.bookmarkAdapter=new Qn}async execute(e){let t;e.recent?t=await this.bookmarkAdapter.getRecentBookmarks(e.limit):e.query?(t=await this.bookmarkAdapter.searchBookmarks(e.query),t=t.slice(0,e.limit)):t=await this.bookmarkAdapter.getRecentBookmarks(e.limit);const r=t.map(e=>({id:e.id,title:e.title,url:e.url,dateAdded:e.dateAdded,parentId:e.parentId}));return{bookmarks:r,count:r.length}}}const to=En({id:Lr().describe("Bookmark ID to remove")});En({success:fn().describe("Whether the bookmark was successfully removed"),message:Lr().describe("Confirmation message")});class ro extends Gn{constructor(){super(...arguments),this.inputSchema=to,this.bookmarkAdapter=new Qn}async execute(e){return await this.bookmarkAdapter.removeBookmark(e.id),{success:!0,message:`Removed bookmark ${e.id}`}}}class no{static parseVersion(e){return e.split(".").map(e=>parseInt(e,10)||0)}static isVersionAtLeast(e,t){const r=this.parseVersion(e),n=this.parseVersion(t);for(let e=0;e<Math.max(r.length,n.length);e++){const t=r[e]||0,o=n[e]||0;if(t>o)return!0;if(t<o)return!1}return!0}}const oo={small:512,medium:768,large:1028};class io{constructor(){}static getInstance(){return io.instance||(io.instance=new io),io.instance}async getInteractiveSnapshot(e,t){try{return s.debug(`[BrowserOSAdapter] Getting interactive snapshot for tab ${e} with options: ${JSON.stringify(t)}`),new Promise((r,n)=>{t?chrome.browserOS.getInteractiveSnapshot(e,t,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Retrieved snapshot with ${e.elements.length} elements`),r(e))}):chrome.browserOS.getInteractiveSnapshot(e,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Retrieved snapshot with ${e.elements.length} elements`),r(e))})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to get interactive snapshot: ${t}`),new Error(`Failed to get interactive snapshot: ${t}`)}}async click(e,t){try{return s.debug(`[BrowserOSAdapter] Clicking node ${t} in tab ${e}`),new Promise((r,n)=>{chrome.browserOS.click(e,t,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):r()})})}catch(e){const r=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to click node: ${r}`),new Error(`Failed to click node ${t}: ${r}`)}}async inputText(e,t,r){try{return s.debug(`[BrowserOSAdapter] Inputting text into node ${t} in tab ${e}`),new Promise((n,o)=>{chrome.browserOS.inputText(e,t,r,()=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):n()})})}catch(e){const r=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to input text: ${r}`),new Error(`Failed to input text into node ${t}: ${r}`)}}async clear(e,t){try{return s.debug(`[BrowserOSAdapter] Clearing node ${t} in tab ${e}`),new Promise((r,n)=>{chrome.browserOS.clear(e,t,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):r()})})}catch(e){const r=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to clear node: ${r}`),new Error(`Failed to clear node ${t}: ${r}`)}}async scrollToNode(e,t){try{return s.debug(`[BrowserOSAdapter] Scrolling to node ${t} in tab ${e}`),new Promise((r,n)=>{chrome.browserOS.scrollToNode(e,t,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):r(e)})})}catch(e){const r=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to scroll to node: ${r}`),new Error(`Failed to scroll to node ${t}: ${r}`)}}async sendKeys(e,t){try{return s.debug(`[BrowserOSAdapter] Sending keys "${t}" to tab ${e}`),new Promise((r,n)=>{chrome.browserOS.sendKeys(e,t,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):r()})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to send keys: ${t}`),new Error(`Failed to send keys: ${t}`)}}async getPageLoadStatus(e){try{return s.debug(`[BrowserOSAdapter] Getting page load status for tab ${e}`),new Promise((t,r)=>{chrome.browserOS.getPageLoadStatus(e,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to get page load status: ${t}`),new Error(`Failed to get page load status: ${t}`)}}async getAccessibilityTree(e){try{return s.debug(`[BrowserOSAdapter] Getting accessibility tree for tab ${e}`),new Promise((t,r)=>{chrome.browserOS.getAccessibilityTree(e,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t(e)})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to get accessibility tree: ${t}`),new Error(`Failed to get accessibility tree: ${t}`)}}async captureScreenshot(e,t,r,n,o){try{const i=t?` (${t})`:"",a=r?" with highlights":"",c=n&&o?` (${n}x${o})`:"";return s.debug(`[BrowserOSAdapter] Capturing screenshot for tab ${e}${i}${a}${c}`),new Promise((c,u)=>{if(void 0!==n&&void 0!==o)chrome.browserOS.captureScreenshot(e,0,r||!1,n,o,t=>{chrome.runtime.lastError?u(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Screenshot captured for tab ${e} (${n}x${o})${a}`),c(t))});else if(void 0!==t||void 0!==r){const n=t?oo[t]:0;void 0!==r?chrome.browserOS.captureScreenshot(e,n,r,t=>{chrome.runtime.lastError?u(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Screenshot captured for tab ${e}${i}${a}`),c(t))}):chrome.browserOS.captureScreenshot(e,n,r=>{chrome.runtime.lastError?u(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Screenshot captured for tab ${e} (${t}: ${n}px)`),c(r))})}else chrome.browserOS.captureScreenshot(e,t=>{chrome.runtime.lastError?u(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Screenshot captured for tab ${e}`),c(t))})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to capture screenshot: ${t}`),new Error(`Failed to capture screenshot: ${t}`)}}async getSnapshot(e,t){try{s.debug(`[BrowserOSAdapter] Getting snapshot for tab ${e} with type ${t}`);const r=await this.getVersion();return s.debug(`[BrowserOSAdapter] BrowserOS version: ${r}`),r&&!no.isVersionAtLeast(r,"137.0.7220.69")?await new Promise((r,n)=>{chrome.browserOS.getSnapshot(e,t,e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Retrieved snapshot: ${JSON.stringify(e)}`),r(e))})}):await new Promise((t,r)=>{chrome.browserOS.getSnapshot(e,e=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Retrieved snapshot: ${JSON.stringify(e)}`),t(e))})})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to get snapshot: ${t}`),new Error(`Failed to get snapshot: ${t}`)}}async getTextSnapshot(e){return this.getSnapshot(e,"text")}async getLinksSnapshot(e){return this.getSnapshot(e,"links")}async invokeAPI(e,...t){try{if(s.debug(`[BrowserOSAdapter] Invoking BrowserOS API: ${e}`),!(e in chrome.browserOS))throw new Error(`Unknown BrowserOS API method: ${e}`);return await chrome.browserOS[e](...t)}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[BrowserOSAdapter] Failed to invoke API ${e}: ${r}`),new Error(`Failed to invoke BrowserOS API ${e}: ${r}`)}}isAPIAvailable(e){return e in chrome.browserOS}getAvailableAPIs(){return Object.keys(chrome.browserOS).filter(e=>"function"==typeof chrome.browserOS[e])}async getVersion(){try{return s.debug("[BrowserOSAdapter] Getting BrowserOS version"),new Promise((e,t)=>{"getVersionNumber"in chrome.browserOS&&"function"==typeof chrome.browserOS.getVersionNumber?chrome.browserOS.getVersionNumber(r=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] BrowserOS version: ${r}`),e(r))}):e(null)})}catch(e){const t=e instanceof Error?e.message:String(e);return s.error(`[BrowserOSAdapter] Failed to get version: ${t}`),null}}async logMetric(e,t){try{return s.debug(`[BrowserOSAdapter] Logging metric: ${e} with properties: ${JSON.stringify(t)}`),new Promise((r,n)=>{"logMetric"in chrome.browserOS&&"function"==typeof chrome.browserOS.logMetric?t?chrome.browserOS.logMetric(e,t,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Metric logged: ${e}`),r())}):chrome.browserOS.logMetric(e,()=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Metric logged: ${e}`),r())}):(s.warn(`[BrowserOSAdapter] logMetric API not available, skipping metric: ${e}`),r())})}catch(e){const t=e instanceof Error?e.message:String(e);return void s.error(`[BrowserOSAdapter] Failed to log metric: ${t}`)}}async executeJavaScript(e,t){try{return s.debug(`[BrowserOSAdapter] Executing JavaScript in tab ${e}`),new Promise((r,n)=>{"executeJavaScript"in chrome.browserOS&&"function"==typeof chrome.browserOS.executeJavaScript?chrome.browserOS.executeJavaScript(e,t,t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] JavaScript executed successfully in tab ${e}`),r(t))}):n(new Error("executeJavaScript API not available"))})}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to execute JavaScript: ${t}`),new Error(`Failed to execute JavaScript: ${t}`)}}async clickCoordinates(e,t,r){try{return s.debug(`[BrowserOSAdapter] Clicking at coordinates (${t}, ${r}) in tab ${e}`),new Promise((n,o)=>{"clickCoordinates"in chrome.browserOS&&"function"==typeof chrome.browserOS.clickCoordinates?chrome.browserOS.clickCoordinates(e,t,r,()=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Successfully clicked at (${t}, ${r}) in tab ${e}`),n())}):o(new Error("clickCoordinates API not available"))})}catch(e){const n=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to click at coordinates: ${n}`),new Error(`Failed to click at coordinates (${t}, ${r}): ${n}`)}}async typeAtCoordinates(e,t,r,n){try{return s.debug(`[BrowserOSAdapter] Typing at coordinates (${t}, ${r}) in tab ${e}`),new Promise((o,i)=>{"typeAtCoordinates"in chrome.browserOS&&"function"==typeof chrome.browserOS.typeAtCoordinates?chrome.browserOS.typeAtCoordinates(e,t,r,n,()=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError.message)):(s.debug(`[BrowserOSAdapter] Successfully typed "${n}" at (${t}, ${r}) in tab ${e}`),o())}):i(new Error("typeAtCoordinates API not available"))})}catch(e){const n=e instanceof Error?e.message:String(e);throw s.error(`[BrowserOSAdapter] Failed to type at coordinates: ${n}`),new Error(`Failed to type at coordinates (${t}, ${r}): ${n}`)}}async getPref(e){try{return console.log(`[BrowserOSAdapter] Getting preference: ${e}`),new Promise((t,r)=>{chrome.browserOS.getPref(e,n=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):(console.log(`[BrowserOSAdapter] Retrieved preference ${e}: ${JSON.stringify(n)}`),t(n))})})}catch(t){const r=t instanceof Error?t.message:String(t);throw console.error(`[BrowserOSAdapter] Failed to get preference: ${r}`),new Error(`Failed to get preference ${e}: ${r}`)}}async setPref(e,t,r){try{return console.log(`[BrowserOSAdapter] Setting preference ${e} to ${JSON.stringify(t)}`),new Promise((n,o)=>{void 0!==r?chrome.browserOS.setPref(e,t,r,t=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):(console.log(`[BrowserOSAdapter] Successfully set preference ${e}`),n(t))}):chrome.browserOS.setPref(e,t,t=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):(console.log(`[BrowserOSAdapter] Successfully set preference ${e}`),n(t))})})}catch(t){const r=t instanceof Error?t.message:String(t);throw console.error(`[BrowserOSAdapter] Failed to set preference: ${r}`),new Error(`Failed to set preference ${e}: ${r}`)}}async getAllPrefs(){try{return console.log("[BrowserOSAdapter] Getting all preferences"),new Promise((e,t)=>{chrome.browserOS.getAllPrefs(r=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):(console.log(`[BrowserOSAdapter] Retrieved ${r.length} preferences`),e(r))})})}catch(e){const t=e instanceof Error?e.message:String(e);throw console.error(`[BrowserOSAdapter] Failed to get all preferences: ${t}`),new Error(`Failed to get all preferences: ${t}`)}}}io.instance=null;const so=()=>io.getInstance(),ao=En({tabId:hn().describe("The tab ID to capture"),size:xn(["small","medium","large"]).optional().default("medium").describe("Screenshot size preset (default: medium)"),showHighlights:fn().optional().default(!0).describe("Show element highlights (default: true)"),width:hn().optional().describe("Exact width in pixels"),height:hn().optional().describe("Exact height in pixels")});En({dataUrl:Lr().describe("Base64-encoded PNG data URL")});class co extends Gn{constructor(){super(...arguments),this.inputSchema=ao,this.browserOSAdapter=io.getInstance()}async execute(e){return{dataUrl:await this.browserOSAdapter.captureScreenshot(e.tabId,e.size,e.showHighlights,e.width,e.height)}}}const uo=En({tabId:hn().describe("The tab ID containing the element"),nodeId:hn().int().positive().describe("The nodeId from interactive snapshot")});class lo extends Gn{constructor(){super(...arguments),this.inputSchema=uo,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.clear(e.tabId,e.nodeId),{success:!0}}}const ho=En({tabId:hn().describe("The tab ID containing the element"),nodeId:hn().int().positive().describe("The nodeId from interactive snapshot")});En({success:fn().describe("Whether the click succeeded")});class po extends Gn{constructor(){super(...arguments),this.inputSchema=ho,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.click(e.tabId,e.nodeId),{success:!0}}}const mo=En({tabId:hn().int().positive().describe("Tab ID to click in"),x:hn().int().nonnegative().describe("X coordinate in viewport pixels"),y:hn().int().nonnegative().describe("Y coordinate in viewport pixels")});class go extends Gn{constructor(){super(...arguments),this.inputSchema=mo,this.browserOS=so()}async execute(e){const{tabId:t,x:r,y:n}=e;return await this.browserOS.clickCoordinates(t,r,n),{success:!0,message:`Successfully clicked at coordinates (${r}, ${n}) in tab ${t}`,coordinates:{x:r,y:n}}}}const fo=En({tabId:hn().describe("The tab ID to execute code in"),code:Lr().describe("JavaScript code to execute")});En({result:bn().describe("The result of the code execution")});class wo extends Gn{constructor(){super(...arguments),this.inputSchema=fo,this.browserOSAdapter=io.getInstance()}async execute(e){return{result:await this.browserOSAdapter.executeJavaScript(e.tabId,e.code)}}}const bo=En({tabId:hn().int().positive().describe("Tab ID to get accessibility tree from")});class yo extends Gn{constructor(){super(...arguments),this.inputSchema=bo,this.browserOSAdapter=io.getInstance()}async execute(e){const{tabId:t}=e;return await this.browserOSAdapter.getAccessibilityTree(t)}}const vo=En({tabId:hn().describe("The tab ID to get snapshot from"),options:En({includeHidden:fn().optional().default(!1).describe("Include hidden elements (default: false)")}).optional().describe("Optional snapshot options")});class $o extends Gn{constructor(){super(...arguments),this.inputSchema=vo,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.getInteractiveSnapshot(e.tabId,e.options)}}const ko=En({tabId:hn().int().positive().describe("Tab ID to check page load status")});class So extends Gn{constructor(){super(...arguments),this.inputSchema=ko,this.browserOSAdapter=io.getInstance()}async execute(e){const{tabId:t}=e,r=await this.browserOSAdapter.getPageLoadStatus(t);return{tabId:t,isResourcesLoading:r.isResourcesLoading,isDOMContentLoaded:r.isDOMContentLoaded,isPageComplete:r.isPageComplete}}}const _o=En({tabId:hn().int().positive().describe("Tab ID to get snapshot from"),type:xn(["text","links"]).default("text").describe("Type of snapshot: text or links"),options:En({context:xn(["visible","full"]).optional(),includeSections:_n(xn(["main","navigation","footer","header","article","aside"])).optional()}).optional().describe("Optional snapshot configuration")});class Ao extends Gn{constructor(){super(...arguments),this.inputSchema=_o,this.browserOSAdapter=io.getInstance()}async execute(e){const{tabId:t,type:r}=e;s.info(`[GetSnapshotAction] Getting snapshot for tab ${t} with type ${r}`);return await this.browserOSAdapter.getSnapshot(t,r)}}const Eo=En({tabId:hn().describe("The tab ID containing the element"),nodeId:hn().int().positive().describe("The nodeId from interactive snapshot"),text:Lr().describe("Text to type into the element")});En({success:fn().describe("Whether the input succeeded")});class Io extends Gn{constructor(){super(...arguments),this.inputSchema=Eo,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.inputText(e.tabId,e.nodeId,e.text),{success:!0}}}const zo=En({tabId:hn().describe("The tab ID to scroll")});En({success:fn().describe("Whether the scroll succeeded")});class To extends Gn{constructor(){super(...arguments),this.inputSchema=zo,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.sendKeys(e.tabId,"PageDown"),await new Promise(e=>setTimeout(e,100)),{success:!0}}}const Oo=En({tabId:hn().describe("The tab ID containing the element"),nodeId:hn().int().positive().describe("The nodeId to scroll to")});class xo extends Gn{constructor(){super(...arguments),this.inputSchema=Oo,this.browserOSAdapter=io.getInstance()}async execute(e){return{scrolled:await this.browserOSAdapter.scrollToNode(e.tabId,e.nodeId)}}}const Co=En({tabId:hn().describe("The tab ID to scroll")});En({success:fn().describe("Whether the scroll succeeded")});class Ro extends Gn{constructor(){super(...arguments),this.inputSchema=Co,this.browserOSAdapter=io.getInstance()}async execute(e){return await this.browserOSAdapter.sendKeys(e.tabId,"PageUp"),await new Promise(e=>setTimeout(e,100)),{success:!0}}}const Po=En({tabId:hn().int().positive().describe("Tab ID to send keys to"),key:xn(["Enter","Delete","Backspace","Tab","Escape","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown"]).describe("Keyboard key to send")});class Fo extends Gn{constructor(){super(...arguments),this.inputSchema=Po,this.browserOS=so()}async execute(e){const{tabId:t,key:r}=e;return await this.browserOS.sendKeys(t,r),{success:!0,message:`Successfully sent "${r}" to tab ${t}`}}}const No=En({tabId:hn().int().positive().describe("Tab ID to type in"),x:hn().int().nonnegative().describe("X coordinate in viewport pixels"),y:hn().int().nonnegative().describe("Y coordinate in viewport pixels"),text:Lr().min(1).describe("Text to type at the location")});class Zo extends Gn{constructor(){super(...arguments),this.inputSchema=No,this.browserOS=so()}async execute(e){const{tabId:t,x:r,y:n,text:o}=e;return await this.browserOS.typeAtCoordinates(t,r,n,o),{success:!0,message:`Successfully typed "${o.substring(0,50)}${o.length>50?"...":""}" at coordinates (${r}, ${n}) in tab ${t}`,coordinates:{x:r,y:n},textLength:o.length}}}const Bo=bn();En({available:fn(),apis:_n(Lr()).optional(),error:Lr().optional()});class Do extends Gn{constructor(){super(...arguments),this.inputSchema=Bo}async execute(e){try{console.log("[CheckBrowserOSAction] Starting diagnostic..."),console.log("[CheckBrowserOSAction] typeof chrome:",typeof chrome),console.log("[CheckBrowserOSAction] chrome exists:",void 0!==chrome);const e=void 0!==chrome.browserOS;if(console.log("[CheckBrowserOSAction] typeof chrome.browserOS:",typeof chrome.browserOS),console.log("[CheckBrowserOSAction] browserOSExists:",e),!e)return console.log("[CheckBrowserOSAction] chrome.browserOS is NOT available"),{available:!1,error:"chrome.browserOS is undefined - not running in BrowserOS Chrome"};const t=[],r=chrome.browserOS;for(const e in r)"function"==typeof r[e]&&t.push(e);return console.log("[CheckBrowserOSAction] Found APIs:",t),{available:!0,apis:t.sort()}}catch(e){console.error("[CheckBrowserOSAction] Error during diagnostic:",e);return{available:!1,error:e instanceof Error?e.message:e?String(e):"Unknown error"}}}}class qo{async searchHistory(e,t=100,r,n){s.debug(`[HistoryAdapter] Searching history: "${e}" (max: ${t})`);try{const o=await chrome.history.search({text:e,maxResults:t,startTime:r,endTime:n});return s.debug(`[HistoryAdapter] Found ${o.length} history items`),o}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to search history: ${t}`),new Error(`Failed to search history: ${t}`)}}async getRecentHistory(e=20,t=24){s.debug(`[HistoryAdapter] Getting ${e} recent history items (last ${t}h)`);try{const r=Date.now()-60*t*60*1e3,n=await chrome.history.search({text:"",maxResults:e,startTime:r});return s.debug(`[HistoryAdapter] Retrieved ${n.length} recent items`),n}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to get recent history: ${t}`),new Error(`Failed to get recent history: ${t}`)}}async getVisits(e){s.debug(`[HistoryAdapter] Getting visits for: ${e}`);try{const t=await chrome.history.getVisits({url:e});return s.debug(`[HistoryAdapter] Found ${t.length} visits for ${e}`),t}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to get visits: ${t}`),new Error(`Failed to get visits: ${t}`)}}async addUrl(e){s.debug(`[HistoryAdapter] Adding URL to history: ${e}`);try{await chrome.history.addUrl({url:e}),s.debug(`[HistoryAdapter] Added URL: ${e}`)}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to add URL: ${t}`),new Error(`Failed to add URL to history: ${t}`)}}async deleteUrl(e){s.debug(`[HistoryAdapter] Removing URL from history: ${e}`);try{await chrome.history.deleteUrl({url:e}),s.debug(`[HistoryAdapter] Removed URL: ${e}`)}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to delete URL: ${t}`),new Error(`Failed to delete URL from history: ${t}`)}}async deleteRange(e,t){s.debug(`[HistoryAdapter] Deleting history range: ${new Date(e).toISOString()} to ${new Date(t).toISOString()}`);try{await chrome.history.deleteRange({startTime:e,endTime:t}),s.debug("[HistoryAdapter] Deleted history range")}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to delete history range: ${t}`),new Error(`Failed to delete history range: ${t}`)}}async deleteAll(){s.warn("[HistoryAdapter] Deleting ALL browser history");try{await chrome.history.deleteAll(),s.warn("[HistoryAdapter] Deleted all history")}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to delete all history: ${t}`),new Error(`Failed to delete all history: ${t}`)}}async getMostVisited(e=10){s.debug(`[HistoryAdapter] Getting ${e} most visited URLs`);try{const t=(await chrome.history.search({text:"",maxResults:1e3,startTime:0})).filter(e=>e.visitCount&&e.visitCount>1).sort((e,t)=>(t.visitCount||0)-(e.visitCount||0)).slice(0,e);return s.debug(`[HistoryAdapter] Found ${t.length} most visited URLs`),t}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[HistoryAdapter] Failed to get most visited: ${t}`),new Error(`Failed to get most visited URLs: ${t}`)}}}const Uo=En({maxResults:hn().int().positive().optional().default(20).describe("Maximum number of results (default: 20)"),hoursBack:hn().int().positive().optional().default(24).describe("How many hours back to search (default: 24)")});En({items:_n(En({id:Lr(),url:Lr().optional(),title:Lr().optional(),lastVisitTime:hn().optional(),visitCount:hn().optional()})),count:hn()});class jo extends Gn{constructor(){super(...arguments),this.inputSchema=Uo,this.historyAdapter=new qo}async execute(e){const t=(await this.historyAdapter.getRecentHistory(e.maxResults,e.hoursBack)).map(e=>({id:e.id,url:e.url,title:e.title,lastVisitTime:e.lastVisitTime,visitCount:e.visitCount}));return{items:t,count:t.length}}}const Lo=En({query:Lr().describe("Search query to match URL or title"),maxResults:hn().int().positive().optional().default(20).describe("Maximum number of results (default: 20)"),startTime:hn().optional().describe("Start time in milliseconds since epoch (optional)"),endTime:hn().optional().describe("End time in milliseconds since epoch (optional)")});En({items:_n(En({id:Lr(),url:Lr().optional(),title:Lr().optional(),lastVisitTime:hn().optional(),visitCount:hn().optional(),typedCount:hn().optional()})),count:hn()});class Mo extends Gn{constructor(){super(...arguments),this.inputSchema=Lo,this.historyAdapter=new qo}async execute(e){const t=(await this.historyAdapter.searchHistory(e.query,e.maxResults,e.startTime,e.endTime)).map(e=>({id:e.id,url:e.url,title:e.title,lastVisitTime:e.lastVisitTime,visitCount:e.visitCount,typedCount:e.typedCount}));return{items:t,count:t.length}}}class Ho{async getActiveTab(e){s.debug("[TabAdapter] Getting active tab"+(void 0!==e?` in window ${e}`:""));try{const t={active:!0};void 0!==e?t.windowId=e:t.currentWindow=!0;const r=await chrome.tabs.query(t);if(0===r.length)throw new Error("No active tab found");return s.debug(`[TabAdapter] Found active tab: ${r[0].id} (${r[0].url})`),r[0]}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[TabAdapter] Failed to get active tab: ${t}`),new Error(`Failed to get active tab: ${t}`)}}async getTab(e){s.debug(`[TabAdapter] Getting tab ${e}`);try{const t=await chrome.tabs.get(e);return s.debug(`[TabAdapter] Found tab: ${t.id} (${t.url})`),t}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[TabAdapter] Failed to get tab ${e}: ${r}`),new Error(`Tab not found (id: ${e})`)}}async getAllTabs(){s.debug("[TabAdapter] Getting all tabs");try{const e=await chrome.tabs.query({});return s.debug(`[TabAdapter] Found ${e.length} tabs`),e}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[TabAdapter] Failed to get all tabs: ${t}`),new Error(`Failed to get tabs: ${t}`)}}async queryTabs(e){s.debug(`[TabAdapter] Querying tabs: ${JSON.stringify(e)}`);try{const t=await chrome.tabs.query(e);return s.debug(`[TabAdapter] Query found ${t.length} tabs`),t}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[TabAdapter] Failed to query tabs: ${t}`),new Error(`Failed to query tabs: ${t}`)}}async getTabsInWindow(e){s.debug(`[TabAdapter] Getting tabs in window ${e}`);try{const t=await chrome.tabs.query({windowId:e});return s.debug(`[TabAdapter] Found ${t.length} tabs in window ${e}`),t}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[TabAdapter] Failed to get tabs in window ${e}: ${r}`),new Error(`Failed to get tabs in window: ${r}`)}}async getCurrentWindowTabs(e){s.debug("[TabAdapter] Getting tabs in "+(void 0!==e?`window ${e}`:"current window"));try{const t={};void 0!==e?t.windowId=e:t.currentWindow=!0;const r=await chrome.tabs.query(t);return s.debug(`[TabAdapter] Found ${r.length} tabs`),r}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[TabAdapter] Failed to get current window tabs: ${t}`),new Error(`Failed to get current window tabs: ${t}`)}}async openTab(e,t=!0,r){const n=e||"chrome://newtab/";s.debug(`[TabAdapter] Opening new tab: ${n} (active: ${t}${void 0!==r?`, window: ${r}`:""})`);try{const e={url:n,active:t};void 0!==r&&(e.windowId=r);const o=await chrome.tabs.create(e);if(!o.id)throw new Error("Created tab has no ID");return s.debug(`[TabAdapter] Created tab ${o.id}: ${n}`),o}catch(e){const t=e instanceof Error?e.message:String(e);throw s.error(`[TabAdapter] Failed to open tab: ${t}`),new Error(`Failed to open tab: ${t}`)}}async closeTab(e){s.debug(`[TabAdapter] Closing tab ${e}`);try{const t=(await chrome.tabs.get(e)).title||"Untitled";await chrome.tabs.remove(e),s.debug(`[TabAdapter] Closed tab ${e}: ${t}`)}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[TabAdapter] Failed to close tab ${e}: ${r}`),new Error(`Failed to close tab ${e}: ${r}`)}}async switchTab(e){s.debug(`[TabAdapter] Switching to tab ${e}`);try{const t=await chrome.tabs.update(e,{active:!0});if(!t)throw new Error("Failed to update tab");return s.debug(`[TabAdapter] Switched to tab ${e}: ${t.title||"Untitled"}`),t}catch(t){const r=t instanceof Error?t.message:String(t);throw s.error(`[TabAdapter] Failed to switch to tab ${e}: ${r}`),new Error(`Failed to switch to tab ${e}: ${r}`)}}async navigateTab(e,t){s.debug(`[TabAdapter] Navigating tab ${e} to ${t}`);try{const r=await chrome.tabs.update(e,{url:t});if(!r)throw new Error("Failed to update tab");return s.debug(`[TabAdapter] Tab ${e} navigating to ${t}`),r}catch(r){const n=r instanceof Error?r.message:String(r);throw s.error(`[TabAdapter] Failed to navigate tab ${e}: ${n}`),new Error(`Failed to navigate tab ${e} to ${t}: ${n}`)}}}const Wo=En({tabId:hn().int().positive().describe("Tab ID to close")});En({success:fn().describe("Whether the tab was successfully closed"),message:Lr().describe("Confirmation message")});class Vo extends Gn{constructor(){super(...arguments),this.inputSchema=Wo,this.tabAdapter=new Ho}async execute(e){return await this.tabAdapter.closeTab(e.tabId),{success:!0,message:`Closed tab ${e.tabId}`}}}const Jo=En({windowId:hn().int().optional().describe("Window ID to get active tab from. If not provided, uses current window.")}).passthrough();class Go extends Gn{constructor(){super(...arguments),this.inputSchema=Jo,this.tabAdapter=new Ho}async execute(e){const t=await this.tabAdapter.getActiveTab(e.windowId);if(void 0===t.id)throw new Error("Active tab has no ID");if(void 0===t.windowId)throw new Error("Active tab has no window ID");return{tabId:t.id,url:t.url||"",title:t.title||"",windowId:t.windowId}}}const Qo=En({currentWindowOnly:fn().optional().default(!1).describe("If true, return only tabs in current window"),windowId:hn().int().positive().optional().describe("If specified, return tabs in this window only"),url:Lr().optional().describe('URL pattern to filter tabs (supports wildcards like "*://*.google.com/*")'),title:Lr().optional().describe("Title pattern to filter tabs")}).describe("Optional filters for querying tabs");class Ko extends Gn{constructor(){super(...arguments),this.inputSchema=Qo,this.tabAdapter=new Ho}async execute(e){let t;if(e.windowId)t=await this.tabAdapter.getTabsInWindow(e.windowId);else if(e.currentWindowOnly)t=await this.tabAdapter.getCurrentWindowTabs();else if(e.url||e.title){const r={};e.url&&(r.url=e.url),e.title&&(r.title=e.title),t=await this.tabAdapter.queryTabs(r)}else t=await this.tabAdapter.getAllTabs();const r=t.filter(e=>void 0!==e.id&&void 0!==e.windowId).map(e=>({id:e.id,url:e.url||"",title:e.title||"",windowId:e.windowId,active:e.active||!1,index:e.index}));return{tabs:r,count:r.length}}}const Xo=En({url:Lr().url().describe("URL to navigate to (must include https://)"),tabId:hn().int().positive().optional().describe("Tab ID to navigate (optional, defaults to active tab)"),windowId:hn().int().optional().describe("Window ID for getting active tab when tabId not provided")});En({tabId:hn().describe("ID of the navigated tab"),url:Lr().describe("URL that the tab is navigating to"),message:Lr().describe("Confirmation message")});class Yo extends Gn{constructor(){super(...arguments),this.inputSchema=Xo,this.tabAdapter=new Ho}async execute(e){let t=e.tabId;if(!t){t=(await this.tabAdapter.getActiveTab(e.windowId)).id}return{tabId:(await this.tabAdapter.navigateTab(t,e.url)).id,url:e.url,message:`Navigating to ${e.url}`}}}const ei=En({url:Lr().url().optional().describe("URL to open (optional, defaults to new tab page)"),active:fn().optional().default(!0).describe("Whether to make the new tab active"),windowId:hn().int().optional().describe("Window ID to open the tab in. If not provided, opens in current window.")});En({tabId:hn().describe("ID of the newly created tab"),url:Lr().describe("URL of the new tab"),title:Lr().optional().describe("Title of the new tab")});class ti extends Gn{constructor(){super(...arguments),this.inputSchema=ei,this.tabAdapter=new Ho}async execute(e){const t=await this.tabAdapter.openTab(e.url,e.active??!0,e.windowId);return{tabId:t.id,url:t.url||t.pendingUrl||e.url||"chrome://newtab/",title:t.title}}}const ri=En({tabId:hn().int().positive().describe("Tab ID to switch to")});En({tabId:hn().describe("ID of the tab that is now active"),url:Lr().describe("URL of the active tab"),title:Lr().describe("Title of the active tab")});class ni extends Gn{constructor(){super(...arguments),this.inputSchema=ri,this.tabAdapter=new Ho}async execute(e){const t=await this.tabAdapter.switchTab(e.tabId);return{tabId:t.id,url:t.url||"",title:t.title||""}}}class oi{constructor(e,t=1e3){this.maxConcurrent=e,this.maxQueueSize=t,this.isProcessing=!1,this.queue=[],1!==e&&s.warn(`ConcurrencyLimiter: maxConcurrent=${e} but extension is single-threaded. Using mutex mode (sequential execution) to prevent race conditions.`),s.info(`ConcurrencyLimiter initialized: sequential=true, queueSize=${t}`)}async execute(e){if(this.queue.length>=this.maxQueueSize)throw s.error(`Queue full (${this.maxQueueSize} requests). Rejecting request.`),new Error(`Controller overloaded. Queue full (${this.maxQueueSize} requests). Server should slow down.`);return new Promise((t,r)=>{this.queue.push({task:e,resolve:t,reject:r});const n=this.isProcessing?"QUEUED (mutex held)":"IMMEDIATE";s.info(`[MUTEX] Task arrival - Status: ${n}, Queue size now: ${this.queue.length}`),this.isProcessing||this.processQueue()})}processQueue(){if(this.isProcessing||0===this.queue.length)return;const e=this.queue.length;this.isProcessing=!0;const{task:t,resolve:r,reject:n}=this.queue.shift();s.info(`[MUTEX] Acquired. Started processing (${e} task(s) were queued, ${this.queue.length} still waiting).`);const o=Date.now();t().then(r).catch(n).finally(()=>{const e=Date.now()-o;this.isProcessing=!1,s.info(`[MUTEX] Released after ${e}ms. ${this.queue.length} task(s) remaining.`),this.processQueue()})}getStats(){return{inFlight:this.isProcessing?1:0,queued:this.queue.length,utilization:this.isProcessing?1:0}}logStats(){const e=this.getStats();s.info(`Concurrency: ${e.inFlight} in-flight (mutex mode), ${e.queued} queued, ${Math.round(100*e.utilization)}% utilization`)}}class ii{constructor(){this.requests=new Map,this.cleanupInterval=null,this.cleanupInterval=setInterval(()=>this.cleanup(),6e4)}start(e,t){this.requests.set(e,{id:e,action:t,startTime:Date.now(),status:"pending"}),s.debug(`Request started: ${e} [${t}]`)}markExecuting(e){const t=this.requests.get(e);t&&(t.status="executing",s.debug(`Request executing: ${e}`))}complete(e,t){const r=this.requests.get(e);r&&(r.status=t?"failed":"completed",r.duration=Date.now()-r.startTime,r.error=t,s.info(`Request ${t?"failed":"completed"}: ${e} [${r.action}] in ${r.duration}ms`),setTimeout(()=>this.requests.delete(e),6e4))}getActiveRequests(){return Array.from(this.requests.values()).filter(e=>"pending"===e.status||"executing"===e.status)}getStats(){const e=Array.from(this.requests.values()),t=e.filter(e=>"pending"===e.status||"executing"===e.status).length,r=e.filter(e=>void 0!==e.duration),n=r.length>0?r.reduce((e,t)=>e+t.duration,0)/r.length:0,o=e.filter(e=>"failed"===e.status).length,i=e.length>0?o/e.length:0;return{inFlight:t,avgDuration:Math.round(n),errorRate:Math.round(100*i)/100,totalRequests:e.length}}getHungRequests(e=3e4){const t=Date.now();return Array.from(this.requests.values()).filter(r=>("pending"===r.status||"executing"===r.status)&&t-r.startTime>e)}cleanup(){const e=Date.now()-3e5;for(const[t,r]of this.requests.entries())("completed"===r.status||"failed"===r.status)&&r.startTime<e&&this.requests.delete(t)}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.requests.clear()}}class si{constructor(){this.activeIds=new Set,this.idTimestamps=new Map,this.cleanupInterval=null,this.cleanupInterval=setInterval(()=>this.cleanup(),6e4)}validate(e){const t=Vn.parse(e);if(this.activeIds.has(t.id))throw s.error(`Duplicate request ID detected: ${t.id}`),new Error(`Duplicate request ID: ${t.id}. Already processing this request.`);return this.activeIds.add(t.id),this.idTimestamps.set(t.id,Date.now()),s.debug(`Request validated: ${t.id} [${t.action}]`),t}markComplete(e){this.activeIds.delete(e),this.idTimestamps.delete(e),s.debug(`Request ID released: ${e}`)}cleanup(){const e=Date.now(),t=e-3e5;for(const[r,n]of this.idTimestamps.entries())n<t&&(s.warn(`Cleaning up stale request ID: ${r} (age: ${Math.round((e-n)/1e3)}s)`),this.activeIds.delete(r),this.idTimestamps.delete(r))}getStats(){return{activeIds:this.activeIds.size}}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.activeIds.clear(),this.idTimestamps.clear()}}class ai{constructor(e=1e3){this.queue=[],this.maxSize=e,s.info(`ResponseQueue initialized: maxSize=${e}`)}enqueue(e){if(this.queue.length>=this.maxSize){const e=this.queue.shift();s.warn(`Response queue full. Dropped oldest response: ${e?.id}`)}this.queue.push(e),s.debug(`Response queued: ${e.id} (queue size: ${this.queue.length})`)}flush(e){let t=0;for(s.info(`Flushing ${this.queue.length} queued responses...`);this.queue.length>0;){const r=this.queue.shift();try{e(r),t++}catch(e){s.error(`Failed to send response ${r.id}: ${e}. Re-queueing.`),this.queue.unshift(r);break}}return s.info(`Flushed ${t} responses. ${this.queue.length} remaining.`),t}size(){return this.queue.length}clear(){const e=this.queue.length;this.queue=[],s.warn(`Response queue cleared. Dropped ${e} responses.`)}isEmpty(){return 0===this.queue.length}}class ci{constructor(e){this.ws=null,this.status=Jn.DISCONNECTED,this.reconnectTimer=null,this.heartbeatTimer=null,this.heartbeatTimeoutTimer=null,this.lastPongReceived=Date.now(),this.pendingPing=!1,this.messageHandlers=new Set,this.statusHandlers=new Set,this.getPort=e,s.info("WebSocketClient initialized")}async connect(){if(this.status!==Jn.CONNECTED){this._setStatus(Jn.CONNECTING);try{const e=await this.getPort(),t=this._buildUrl(e);s.info(`Connecting to ${t}`),this.ws=new WebSocket(t),this.ws.onopen=this._handleOpen.bind(this),this.ws.onmessage=this._handleMessage.bind(this),this.ws.onerror=this._handleError.bind(this),this.ws.onclose=this._handleClose.bind(this),await this._waitForConnection()}catch(e){s.error(`Connection failed: ${e}`),this._handleConnectionFailure()}}else s.debug("Already connected")}disconnect(){s.info("Disconnecting..."),this._clearTimers(),this.ws&&(this.ws.close(),this.ws=null),this._setStatus(Jn.DISCONNECTED)}send(e){this._sendSerialized(e)}onMessage(e){this.messageHandlers.add(e)}onStatusChange(e){this.statusHandlers.add(e)}isConnected(){return this.status===Jn.CONNECTED}getStatus(){return this.status}_buildUrl(t){const{protocol:r,host:n,path:o}=e;return`${r}://${n}:${t}${o}`}async _waitForConnection(){return new Promise((t,r)=>{const n=setTimeout(()=>{r(new Error("Connection timeout"))},e.connectionTimeout),o=()=>{this.status===Jn.CONNECTED?(clearTimeout(n),t()):this.status===Jn.ERROR?(clearTimeout(n),r(new Error("Connection failed"))):setTimeout(o,100)};o()})}_handleOpen(){s.info("WebSocket connected"),this.lastPongReceived=Date.now(),this.pendingPing=!1,this._setStatus(Jn.CONNECTED),this._startHeartbeat()}_handleMessage(e){try{const t=JSON.parse(e.data);if("pong"===t.type)return this.lastPongReceived=Date.now(),this.pendingPing=!1,void s.debug("Received pong from server");s.debug(`Received: ${JSON.stringify(t).substring(0,100)}...`),this.messageHandlers.forEach(e=>e(t))}catch(e){s.error(`Failed to parse message: ${e}`)}}_handleError(e){s.error(`WebSocket error: ${e}`),this._setStatus(Jn.ERROR)}_handleClose(e){s.warn(`WebSocket closed: code=${e.code}, reason=${e.reason}`),this._clearTimers(),this.ws=null,this.status!==Jn.DISCONNECTED&&this._reconnect()}_handleConnectionFailure(){this._setStatus(Jn.ERROR),this._reconnect()}_reconnect(){if(this.reconnectTimer)return;this._setStatus(Jn.RECONNECTING);const t=e.reconnectIntervalMs;s.warn(`Reconnecting in ${Math.round(t)}ms`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect().catch(e=>{s.error(`Reconnection failed: ${e}`)})},t)}_startHeartbeat(){this._clearHeartbeat(),this.heartbeatTimer=setInterval(()=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;const t=Date.now()-this.lastPongReceived;if(t>e.heartbeatInterval+e.heartbeatTimeout)return s.error(`Heartbeat timeout: no pong received for ${t}ms`),void this._handleHeartbeatTimeout();try{this._sendSerialized({type:"ping"}),this.pendingPing=!0,s.debug("Sent heartbeat ping"),this._clearHeartbeatTimeout(),this.heartbeatTimeoutTimer=setTimeout(()=>{this.pendingPing&&(s.error(`Ping timeout: no pong received within ${e.heartbeatTimeout}ms`),this._handleHeartbeatTimeout())},e.heartbeatTimeout)}catch(e){s.error(`Failed to send ping: ${e}`),this._handleHeartbeatTimeout()}},e.heartbeatInterval)}_handleHeartbeatTimeout(){s.warn("Heartbeat failed, forcing reconnection"),this.ws&&this.ws.close()}_clearHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this._clearHeartbeatTimeout()}_clearHeartbeatTimeout(){this.heartbeatTimeoutTimer&&(clearTimeout(this.heartbeatTimeoutTimer),this.heartbeatTimeoutTimer=null)}_clearTimers(){this._clearHeartbeat(),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}_setStatus(e){this.status!==e&&(this.status=e,s.info(`Status changed: ${e}`),this.statusHandlers.forEach(t=>t(e)))}_sendSerialized(e){if(this.status!==Jn.CONNECTED)throw new Error("WebSocket not connected");if(!this.ws)throw new Error("WebSocket instance is null");const t=JSON.stringify(e);s.debug(`Sending: ${t.substring(0,100)}...`),this.ws.send(t)}}class ui{constructor(e){s.info("Initializing BrowserOS Controller..."),this.requestTracker=new ii,this.concurrencyLimiter=new oi(t,r),this.requestValidator=new si,this.responseQueue=new ai,this.wsClient=new ci(e),this.actionRegistry=new a,this.registerActions(),this.setupWebSocketHandlers()}async start(){s.info("Starting BrowserOS Controller..."),await this.wsClient.connect(),await this.reportOwnedWindows()}async reportOwnedWindows(){try{const e=(await chrome.windows.getAll()).map(e=>e.id).filter(e=>void 0!==e);e.length>0&&(this.wsClient.send({type:"register_windows",windowIds:e}),s.info("Reported owned windows to server",{windowCount:e.length,windowIds:e}))}catch(e){s.warn("Failed to report owned windows",{error:e instanceof Error?e.message:String(e)})}}notifyWindowCreated(e){try{this.wsClient.send({type:"window_created",windowId:e}),s.debug("Sent window_created event",{windowId:e})}catch(t){s.warn("Failed to send window_created event",{windowId:e,error:t instanceof Error?t.message:String(t)})}}notifyWindowRemoved(e){try{this.wsClient.send({type:"window_removed",windowId:e}),s.debug("Sent window_removed event",{windowId:e})}catch(t){s.warn("Failed to send window_removed event",{windowId:e,error:t instanceof Error?t.message:String(t)})}}stop(){s.info("Stopping BrowserOS Controller..."),this.wsClient.disconnect(),this.requestTracker.destroy(),this.requestValidator.destroy(),this.responseQueue.clear()}logStats(){const e=this.getStats();s.info("=== Controller Stats ==="),s.info(`Connection: ${e.connection}`),s.info(`Requests: ${JSON.stringify(e.requests)}`),s.info(`Concurrency: ${JSON.stringify(e.concurrency)}`),s.info(`Validator: ${JSON.stringify(e.validator)}`),s.info(`Response Queue: ${e.responseQueue.size} queued`)}getStats(){return{connection:this.wsClient.getStatus(),requests:this.requestTracker.getStats(),concurrency:this.concurrencyLimiter.getStats(),validator:this.requestValidator.getStats(),responseQueue:{size:this.responseQueue.size()}}}isConnected(){return this.wsClient.isConnected()}notifyWindowFocused(e){try{this.wsClient.send({type:"focused",windowId:e}),s.debug("Sent focused event",{windowId:e})}catch(t){s.warn("Failed to send focused event",{windowId:e,error:t instanceof Error?t.message:String(t)})}}registerActions(){s.info("Registering actions..."),this.actionRegistry.register("checkBrowserOS",new Do),this.actionRegistry.register("getActiveTab",new Go),this.actionRegistry.register("getTabs",new Ko),this.actionRegistry.register("openTab",new ti),this.actionRegistry.register("closeTab",new Vo),this.actionRegistry.register("switchTab",new ni),this.actionRegistry.register("navigate",new Yo),this.actionRegistry.register("getBookmarks",new eo),this.actionRegistry.register("createBookmark",new Xn),this.actionRegistry.register("removeBookmark",new ro),this.actionRegistry.register("searchHistory",new Mo),this.actionRegistry.register("getRecentHistory",new jo),this.actionRegistry.register("getInteractiveSnapshot",new $o),this.actionRegistry.register("click",new po),this.actionRegistry.register("inputText",new Io),this.actionRegistry.register("clear",new lo),this.actionRegistry.register("scrollToNode",new xo),this.actionRegistry.register("captureScreenshot",new co),this.actionRegistry.register("scrollDown",new To),this.actionRegistry.register("scrollUp",new Ro),this.actionRegistry.register("executeJavaScript",new wo),this.actionRegistry.register("sendKeys",new Fo),this.actionRegistry.register("getPageLoadStatus",new So),this.actionRegistry.register("getSnapshot",new Ao),this.actionRegistry.register("getAccessibilityTree",new yo),this.actionRegistry.register("clickCoordinates",new go),this.actionRegistry.register("typeAtCoordinates",new Zo);const e=this.actionRegistry.getAvailableActions();s.info(`Registered ${e.length} action(s): ${e.join(", ")}`)}setupWebSocketHandlers(){this.wsClient.onMessage(e=>{this.handleIncomingMessage(e)}),this.wsClient.onStatusChange(e=>{this.handleStatusChange(e)})}handleIncomingMessage(e){const t=e;t.action?this.processRequest(t).catch(e=>{s.error(`Unhandled error processing request ${t.id}: ${e}`)}):void 0!==t.ok?(s.info(`Received server message: ${t.id} - ${t.ok?"success":"error"}`),t.data&&s.debug(`Server data: ${JSON.stringify(t.data)}`)):s.warn(`Received unknown message format: ${JSON.stringify(t)}`)}async processRequest(e){let t,r;try{t=this.requestValidator.validate(e),r=t.id,this.requestTracker.start(t.id,t.action),await this.concurrencyLimiter.execute(async()=>{this.requestTracker.markExecuting(t.id),await this.executeAction(t)}),this.requestTracker.complete(t.id),this.requestValidator.markComplete(t.id)}catch(e){const t=e instanceof Error?e.message:String(e);s.error(`Request processing failed: ${t}`),r&&(this.requestTracker.complete(r,t),this.requestValidator.markComplete(r),this.sendResponse({id:r,ok:!1,error:t}))}}async executeAction(e){s.info(`Executing action: ${e.action} [${e.id}]`);const t=await this.actionRegistry.dispatch(e.action,e.payload);this.sendResponse({id:e.id,ok:t.ok,data:t.data,error:t.error});const r=t.ok?"succeeded":"failed";s.info(`Action ${r}: ${e.action} [${e.id}]`)}sendResponse(e){try{this.wsClient.isConnected()?this.wsClient.send(e):(s.warn(`Not connected. Queueing response: ${e.id}`),this.responseQueue.enqueue(e))}catch(t){s.error(`Failed to send response ${e.id}: ${t}`),this.responseQueue.enqueue(e)}}handleStatusChange(e){s.info(`Connection status changed: ${e}`),e===Jn.CONNECTED&&(this.responseQueue.isEmpty()||(s.info(`Flushing ${this.responseQueue.size()} queued responses...`),this.responseQueue.flush(e=>{this.wsClient.send(e)})))}}async function di(){try{const t=so(),r=await t.getPref("browseros.server.extension_port");return r&&"number"==typeof r.value?(s.info(`Using port from BrowserOS preferences: ${r.value}`),r.value):(s.warn(`Port preference not found, using default: ${e.defaultExtensionPort}`),e.defaultExtensionPort)}catch(t){return s.error(`Failed to get port from BrowserOS preferences: ${t}, using default: ${e.defaultExtensionPort}`),e.defaultExtensionPort}}const li="browseros-keepalive";class hi{static async start(){this.isInitialized?s.debug("KeepAlive already started"):(chrome.alarms.onAlarm.addListener(e=>{e.name===li&&s.debug("KeepAlive: ping (service worker alive)")}),await chrome.alarms.create(li,{periodInMinutes:.33}),this.isInitialized=!0,s.info("KeepAlive started: alarm every 19.8s"))}static async stop(){await chrome.alarms.clear(li),this.isInitialized=!1,s.info("KeepAlive stopped")}}hi.isInitialized=!1;const pi=globalThis,mi=pi.__browserosControllerState??(()=>{const e={controller:pi.__browserosController??null,initPromise:null,statsTimer:null};return pi.__browserosControllerState=e,e})();function gi(e){pi.__browserosController=e}function fi(){mi.statsTimer&&(clearInterval(mi.statsTimer),mi.statsTimer=null)}async function wi(){if(mi.controller)return mi.controller;mi.initPromise||(mi.initPromise=(async()=>{try{await hi.start();const e=new ui(di);return await e.start(),mi.controller=e,gi(e),mi.statsTimer||(mi.statsTimer=setInterval(()=>{mi.controller?.logStats()},3e4)),e}catch(e){mi.controller=null,gi(null),fi();try{await hi.stop()}catch{}throw e}finally{mi.initPromise=null}})());const e=mi.initPromise;if(!e)throw new Error("Controller init promise missing");return e}function bi(e){wi().catch(t=>{const r=t instanceof Error?t.message:JSON.stringify(t);s.error("Controller failed to start",{trigger:e,error:r})})}s.info("Extension loaded"),chrome.runtime.onInstalled.addListener(()=>{s.info("Extension installed")}),chrome.runtime.onStartup.addListener(()=>{s.info("Browser startup event"),bi("runtime.onStartup")}),bi("service-worker-init"),chrome.windows.onFocusChanged.addListener(e=>{e!==chrome.windows.WINDOW_ID_NONE&&async function(e){(await wi()).notifyWindowFocused(e)}(e).catch(t=>{const r=t instanceof Error?t.message:JSON.stringify(t);s.warn("Failed to notify focus change",{windowId:e,error:r})})}),chrome.windows.onCreated.addListener(e=>{void 0!==e.id&&async function(e){(await wi()).notifyWindowCreated(e)}(e.id).catch(t=>{const r=t instanceof Error?t.message:JSON.stringify(t);s.warn("Failed to notify window created",{windowId:e.id,error:r})})}),chrome.windows.onRemoved.addListener(e=>{(async function(e){(await wi()).notifyWindowRemoved(e)})(e).catch(t=>{const r=t instanceof Error?t.message:JSON.stringify(t);s.warn("Failed to notify window removed",{windowId:e,error:r})})}),chrome.runtime.onSuspend?.addListener(()=>{s.info("Extension suspending"),async function(e){if(s.info("Controller shutdown requested",{reason:e}),mi.initPromise)try{await mi.initPromise}catch{}const t=mi.controller;if(!t){try{await hi.stop()}catch{}return fi(),void gi(null)}t.stop(),mi.controller=null,gi(null),fi();try{await hi.stop()}catch{}}("runtime.onSuspend")})})();